// ============================================
// ÓRDENES DE TRABAJO
// ============================================

model Order {
  id                  String        @id @default(uuid())
  numero              String        @unique
  descripcion         String
  cliente             String
  contactoCliente     String?
  telefonoCliente     String?
  direccion           String?
  
  estado              OrderStatus   @default(planeacion)
  subEstado           OrderSubState @default(solicitud_recibida)
  prioridad           OrderPriority @default(media)
  
  fechaFinEstimada    DateTime?
  fechaInicio         DateTime?
  fechaFin            DateTime?

  // Costos
  presupuestoEstimado Float?        @default(0)
  costoReal           Float?        @default(0)
  varianzaCosto       Float?        @default(0)
  impuestosAplicables Float?        @default(0)
  margenUtilidad      Float?        @default(0)

  // HES
  requiereHES         Boolean       @default(true)
  cumplimientoHES     Boolean       @default(false)

  // Observaciones y cancelación
  observaciones       String?
  motivoCancelacion   String?
  canceladaEn         DateTime?
  canceladaPorId      String?

  creadorId           String?
  asignadoId          String?

  creador             User?         @relation("OrderCreator", fields: [creadorId], references: [id], onDelete: SetNull)
  asignado            User?         @relation("OrderAssignee", fields: [asignadoId], references: [id], onDelete: SetNull)
  canceladaPor        User?         @relation("OrderCanceller", fields: [canceladaPorId], references: [id], onDelete: SetNull)

  // Relaciones básicas
  items               OrderItem[]
  evidencias          Evidence[]
  costos              Cost[]

  // Relaciones de proceso
  planeacion          Planeacion?
  ejecucion           Ejecucion?
  evidenciasEjecucion EvidenciaEjecucion[]

  // Relaciones HES
  equiposHES          OrdenEquipoHES[]
  inspeccionesHES     InspeccionHES[]

  // Relaciones de cierre
  acta                     Acta?
  ses                      SES?
  factura                  Factura?
  cierreAdministrativo     CierreAdministrativo?

  // Relaciones de flujo 14 pasos
  visitas                  VisitaTecnica[]
  propuesta                PropuestaEconomica?
  stateHistory             OrderStateHistory[]
  comparativa              ComparativaCostos?
  alertas                  AlertaAutomatica[]
  formularioInstancias     FormularioInstancia[]

  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt

  @@index([estado, prioridad, fechaInicio])
  @@index([subEstado, createdAt(sort: Desc)])
  @@index([cliente, estado])
  @@index([asignadoId, estado])
  @@index([creadorId])
  @@index([numero])
  @@index([requiereHES, cumplimientoHES])
  @@map("orders")
}

model OrderItem {
  id              String    @id @default(uuid())
  descripcion     String
  cantidad        Int       @default(1)
  unidad          String    @default("UND")
  completado      Boolean   @default(false)
  completadoEn    DateTime?
  completadoPorId String?
  notas           String?

  orderId         String
  orden           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  completadoPor   User?     @relation("ItemCompletador", fields: [completadoPorId], references: [id], onDelete: SetNull)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orderId, completado])
  @@map("order_items")
}

model Evidence {
  id            String        @id @default(uuid())
  tipo          TipoEvidencia
  url           String
  urlThumbnail  String?
  descripcion   String?
  tamanoBytes   BigInt?
  mimeType      String?
  metadata      Json?

  orderId       String
  subidoPorId   String?

  orden         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  subidoPor     User?         @relation("EvidenciaSubidor", fields: [subidoPorId], references: [id], onDelete: SetNull)

  createdAt     DateTime      @default(now())

  @@index([orderId, tipo])
  @@index([subidoPorId])
  @@index([createdAt(sort: Desc)])
  @@map("evidences")
}

model Cost {
  id              String    @id @default(uuid())
  concepto        String
  monto           Float
  tipo            TipoCosto
  descripcion     String?
  cantidad        Int?      @default(1)
  precioUnitario  Float?
  facturable      Boolean   @default(true)
  facturado       Boolean   @default(false)
  numeroFactura   String?

  orderId         String
  creadoPorId     String?

  orden           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  creadoPor       User?     @relation("CostoCreador", fields: [creadoPorId], references: [id], onDelete: SetNull)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orderId, tipo])
  @@index([facturado])
  @@index([creadoPorId])
  @@map("costs")
}

// ============================================
// FLUJO 14 PASOS - STATE MACHINE
// ============================================

model OrderStateHistory {
  id          String         @id @default(uuid())
  ordenId     String
  orden       Order          @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  fromState   OrderSubState?
  toState     OrderSubState
  
  userId      String?
  user        User?          @relation("StateChangeUser", fields: [userId], references: [id])
  
  notas       String?
  metadata    Json?
  
  createdAt   DateTime       @default(now())
  
  @@index([ordenId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("order_state_history")
}

model VisitaTecnica {
  id                String    @id @default(uuid())
  ordenId           String
  orden             Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  fechaProgramada   DateTime
  fechaRealizada    DateTime?
  duracionMinutos   Int?
  
  tecnicoId         String
  tecnico           User      @relation("VisitaTecnico", fields: [tecnicoId], references: [id])
  
  mediciones        Json?
  fotosUrl          String[]
  observaciones     String?
  coordenadas       Json?
  
  completada        Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([ordenId])
  @@index([tecnicoId])
  @@index([fechaProgramada])
  @@map("visitas_tecnicas")
}

model PropuestaEconomica {
  id                  String    @id @default(uuid())
  ordenId             String    @unique
  orden               Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  costoManoObra       Float     @default(0)
  costoMateriales     Float     @default(0)
  costoEquipos        Float     @default(0)
  costoTransporte     Float     @default(0)
  otrosCostos         Float     @default(0)
  
  subtotal            Float     @default(0)
  impuestos           Float     @default(0)
  margenUtilidad      Float     @default(0)
  total               Float     @default(0)
  
  numeroVersion       Int       @default(1)
  aprobada            Boolean   @default(false)
  numeroPO            String?
  fechaEnvio          DateTime?
  fechaAprobacion     DateTime?
  fechaRechazo        DateTime?
  motivoRechazo       String?
  
  urlArchivo          String?
  
  creadoPorId         String?
  aprobadoPorId       String?
  rechazadoPorId      String?
  
  creadoPor           User?     @relation("PropuestaCreador", fields: [creadoPorId], references: [id])
  aprobadoPor         User?     @relation("PropuestaAprobador", fields: [aprobadoPorId], references: [id])
  rechazadoPor        User?     @relation("PropuestaRechazador", fields: [rechazadoPorId], references: [id])
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@index([ordenId])
  @@index([creadoPorId])
  @@map("propuestas_economicas")
}

model AlertaAutomatica {
  id            String          @id @default(uuid())
  tipo          TipoAlerta
  prioridad     PrioridadAlerta @default(info)
  
  ordenId       String
  orden         Order           @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  titulo        String
  mensaje       String
  
  usuarioId     String?
  usuario       User?           @relation("AlertaUsuario", fields: [usuarioId], references: [id])
  
  resueltoPorId String?
  resueltoPor   User?           @relation("AlertaResuelto", fields: [resueltoPorId], references: [id])
  
  leida         Boolean         @default(false)
  resuelta      Boolean         @default(false)
  
  metadata      Json?
  
  createdAt     DateTime        @default(now())
  leidaAt       DateTime?
  resueltaAt    DateTime?
  
  @@index([usuarioId, leida])
  @@index([tipo, createdAt(sort: Desc)])
  @@index([ordenId])
  @@index([prioridad, resuelta])
  @@map("alertas_automaticas")
}

model ComparativaCostos {
  id              String    @id @default(uuid())
  ordenId         String    @unique
  orden           Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  estimadoManoObra      Float   @default(0)
  estimadoMateriales    Float   @default(0)
  estimadoEquipos       Float   @default(0)
  estimadoTransporte    Float   @default(0)
  estimadoOtros         Float   @default(0)
  totalEstimado         Float   @default(0)
  
  realManoObra          Float   @default(0)
  realMateriales        Float   @default(0)
  realEquipos           Float   @default(0)
  realTransporte        Float   @default(0)
  realOtros             Float   @default(0)
  totalReal             Float   @default(0)
  
  varianzaPorcentaje    Float   @default(0)
  margenRealizado       Float   @default(0)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([ordenId])
  @@map("comparativa_costos")
}
