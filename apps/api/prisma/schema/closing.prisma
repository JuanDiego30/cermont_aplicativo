// ============================================
// CIERRE ADMINISTRATIVO
// ============================================

model Acta {
  id                 String     @id @default(uuid())
  numero             String     @unique
  ordenId            String     @unique
  estado             EstadoActa @default(borrador)

  fechaEmision       DateTime   @default(now())
  fechaEntrega       DateTime?
  trabajosRealizados String
  observaciones      String?

  firmaTecnico       String?
  firmaCliente       String?
  nombreFirmaTecnico String?
  nombreFirmaCliente String?
  cedulaFirmaTecnico String?
  cedulaFirmaCliente String?
  cargoFirmaTecnico  String?
  cargoFirmaCliente  String?
  fechaFirma         DateTime?

  archivoActaPDF     String?
  adjuntos           String[]

  alertaEnviada      Boolean    @default(false)
  diasSinFirmar      Int        @default(0)

  creadoPorId        String?
  aprobadoPorId      String?

  orden              Order      @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  creadoPor          User?      @relation("ActaCreador", fields: [creadoPorId], references: [id], onDelete: SetNull)
  aprobadoPor        User?      @relation("ActaAprobador", fields: [aprobadoPorId], references: [id], onDelete: SetNull)

  cierreAdministrativo CierreAdministrativo?

  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  @@index([estado])
  @@index([numero])
  @@index([creadoPorId])
  @@map("actas")
}

model SES {
  id                  String    @id @default(uuid())
  numeroSES           String    @unique
  ordenId             String    @unique
  estado              EstadoSES @default(no_creada)

  fechaCreacion       DateTime  @default(now())
  fechaEnvio          DateTime?
  fechaAprobacion     DateTime?

  codigoAriba         String?
  urlAriba            String?
  numeroPO            String?

  descripcionServicio String
  valorTotal          Float
  observaciones       String?

  alertaEnviada       Boolean   @default(false)
  diasSinAprobar      Int       @default(0)

  creadoPorId         String?
  aprobadoPorId       String?

  orden               Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  creadoPor           User?     @relation("SESCreador", fields: [creadoPorId], references: [id], onDelete: SetNull)
  aprobadoPor         User?     @relation("SESAprobador", fields: [aprobadoPorId], references: [id], onDelete: SetNull)

  cierreAdministrativo CierreAdministrativo?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([estado])
  @@index([numeroSES])
  @@index([creadoPorId])
  @@map("ses")
}

model Factura {
  id               String        @id @default(uuid())
  numeroFactura    String        @unique
  ordenId          String        @unique
  estado           EstadoFactura @default(no_creada)

  fechaEmision     DateTime      @default(now())
  fechaVencimiento DateTime?
  fechaAprobacion  DateTime?
  fechaPago        DateTime?

  subtotal         Float
  impuestos        Float
  descuentos       Float?        @default(0)
  valorTotal       Float

  conceptos        String
  observaciones    String?

  archivoFacturaPDF String?
  adjuntos          String[]

  codigoAriba      String?
  urlAriba         String?
  numeroSAP        String?

  alertaEnviada    Boolean       @default(false)
  diasVencidos     Int           @default(0)

  creadoPorId      String?
  aprobadoPorId    String?

  orden            Order         @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  creadoPor        User?         @relation("FacturaCreador", fields: [creadoPorId], references: [id], onDelete: SetNull)
  aprobadoPor      User?         @relation("FacturaAprobador", fields: [aprobadoPorId], references: [id], onDelete: SetNull)

  cierreAdministrativo CierreAdministrativo?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([estado])
  @@index([numeroFactura])
  @@index([creadoPorId])
  @@map("facturas")
}

model CierreAdministrativo {
  id      String @id @default(uuid())
  ordenId String @unique
  orden   Order  @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  actaId String? @unique
  acta   Acta?   @relation(fields: [actaId], references: [id])

  sesId String? @unique
  ses   SES?    @relation(fields: [sesId], references: [id])

  facturaId String?  @unique
  factura   Factura? @relation(fields: [facturaId], references: [id])

  porcentajeCompletado Int     @default(0)
  estaCompleto         Boolean @default(false)

  fechaInicioOrden    DateTime
  fechaFinOrden       DateTime?
  fechaInicioCierre   DateTime  @default(now())
  fechaCierreCompleto DateTime?

  diasParaCierre      Int     @default(0)
  diasTranscurridos   Int     @default(0)

  observaciones String?
  bloqueos      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ordenId])
  @@index([estaCompleto])
  @@map("cierre_administrativo")
}
