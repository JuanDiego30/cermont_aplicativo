// ============================================
// FORMULARIOS DINÁMICOS MODERNOS
// ============================================

model FormTemplate {
  id          String         @id @default(uuid())
  nombre      String         @unique
  tipo        TipoFormulario
  categoria   String
  version     String         @default("1.0")
  activo      Boolean        @default(true)

  schema      Json
  uiSchema    Json?

  descripcion String?
  tags        String[]

  creadoPorId String?
  creadoPor   User?          @relation("FormTemplateCreador", fields: [creadoPorId], references: [id], onDelete: SetNull)

  instancias  FormularioInstancia[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([tipo, activo])
  @@index([categoria])
  @@index([creadoPorId])
  @@map("form_templates")
}

model FormularioInstancia {
  id              String        @id @default(uuid())
  templateId      String
  template        FormTemplate  @relation(fields: [templateId], references: [id])

  ordenId         String?
  orden           Order?        @relation(fields: [ordenId], references: [id])

  data            Json

  completadoPorId String?
  completadoPor   User?         @relation("FormulariosCompletados", fields: [completadoPorId], references: [id])
  
  revisadoPorId   String?
  revisadoPor     User?         @relation("FormulariosRevisados", fields: [revisadoPorId], references: [id])
  
  completadoEn    DateTime?
  revisadoEn      DateTime?

  estado          String        @default("borrador")

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([templateId])
  @@index([ordenId])
  @@index([completadoPorId])
  @@index([estado])
  @@map("formularios_instancias")
}

// ============================================
// FORMULARIOS DINÁMICOS - LEGACY COMPATIBILITY
// ============================================

model FormularioTemplate {
  id          String   @id @default(uuid())
  nombre      String
  descripcion String?
  schema      String
  version     Int      @default(1)
  activo      Boolean  @default(true)

  creadoPorId String?
  
  creadoPor   User?    @relation("FormularioTemplateCreador", fields: [creadoPorId], references: [id], onDelete: SetNull)
  respuestas  FormularioRespuesta[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([activo])
  @@index([creadoPorId])
  @@map("formulario_templates")
}

model FormularioRespuesta {
  id              String             @id @default(uuid())

  templateId      String
  ordenId         String?
  respuestas      String

  completadoPorId String?

  template        FormularioTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([templateId])
  @@index([ordenId])
  @@map("formulario_respuestas")
}
