// ============================================
// EJECUCIÃ“N Y SEGUIMIENTO
// ============================================

model Ejecucion {
  id                  String          @id @default(uuid())
  ordenId             String          @unique
  planeacionId        String          @unique
  estado              EstadoEjecucion @default(no_iniciada)
  avancePercentaje    Int             @default(0)
  horasActuales       Float           @default(0)
  horasEstimadas      Float
  fechaInicio         DateTime
  fechaTermino        DateTime?
  ubicacionGPS        Json?
  observacionesInicio String?
  observaciones       String?
  sincronizado        Boolean         @default(false)

  iniciadoPorId       String?
  finalizadoPorId     String?

  orden               Order                @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  planeacion          Planeacion           @relation(fields: [planeacionId], references: [id], onDelete: Cascade)
  iniciadoPor         User?                @relation("EjecucionIniciador", fields: [iniciadoPorId], references: [id], onDelete: SetNull)
  finalizadoPor       User?                @relation("EjecucionFinalizador", fields: [finalizadoPorId], references: [id], onDelete: SetNull)

  tareas              TareaEjecucion[]
  checklists          ChecklistEjecucion[]
  evidenciasEjecucion EvidenciaEjecucion[]
  fotosEvidencia      FotoEvidencia[]      @relation("EjecucionFotos")

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@index([estado])
  @@index([sincronizado])
  @@index([iniciadoPorId])
  @@index([finalizadoPorId])
  @@map("ejecuciones")
}

model TareaEjecucion {
  id              String    @id @default(uuid())
  ejecucionId     String
  descripcion     String
  completada      Boolean   @default(false)
  horasEstimadas  Float
  horasReales     Float?
  observaciones   String?
  completadaEn    DateTime?
  completadaPorId String?

  ejecucion       Ejecucion @relation(fields: [ejecucionId], references: [id], onDelete: Cascade)
  completadaPor   User?     @relation("TareaCompletador", fields: [completadaPorId], references: [id], onDelete: SetNull)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([ejecucionId, completada])
  @@index([completadaPorId])
  @@map("tareas_ejecucion")
}

model FotoEvidencia {
  id              String                  @id @default(uuid())
  ejecucionId     String?
  checklistId     String?
  checklistItemId String?
  url             String
  urlThumbnail    String?
  descripcion     String?
  fase            String?
  tamanoBytes     BigInt?
  mimeType        String?
  cargadoPorId    String?
  cargadoEn       DateTime                @default(now())
  sincronizado    Boolean                 @default(false)

  ejecucion       Ejecucion?              @relation("EjecucionFotos", fields: [ejecucionId], references: [id], onDelete: SetNull)
  checklist       ChecklistEjecucion?     @relation("ChecklistFotos", fields: [checklistId], references: [id], onDelete: SetNull)
  checklistItem   ChecklistItemEjecucion? @relation("ItemFotos", fields: [checklistItemId], references: [id], onDelete: SetNull)
  cargadoPor      User?                   @relation("FotoCargadaPor", fields: [cargadoPorId], references: [id], onDelete: SetNull)

  @@index([ejecucionId])
  @@index([checklistId])
  @@index([checklistItemId])
  @@index([cargadoPorId])
  @@index([sincronizado])
  @@map("fotos_evidencia")
}

model EvidenciaEjecucion {
  id            String   @id @default(uuid())
  ejecucionId   String
  ordenId       String
  tipo          String
  nombreArchivo String
  rutaArchivo   String
  tamano        BigInt
  mimeType      String   @default("application/octet-stream")
  descripcion   String
  ubicacionGPS  Json?
  tags          String[]
  subidoPor     String
  verificada    Boolean  @default(false)
  verificadoPor String?
  verificadoEn  DateTime?

  // New fields for DDD refactor
  thumbnailPath String?
  status        String   @default("READY")
  metadata      Json?
  deletedAt     DateTime?
  deletedBy     String?
  
  ejecucion     Ejecucion @relation(fields: [ejecucionId], references: [id], onDelete: Cascade)
  orden         Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([ejecucionId])
  @@index([ordenId, tipo])
  @@index([verificada])
  @@index([status])
  @@index([deletedAt])
  @@map("evidencias_ejecucion")
}
