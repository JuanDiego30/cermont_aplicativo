// Prisma Schema CERMONT V3.0 - MongoDB
// Migrated from PostgreSQL to MongoDB

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// USUARIOS Y AUTENTICACIÓN
// ============================================

model User {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  email    String   @unique
  password String?
  name     String
  role     UserRole @default(tecnico)
  phone    String?
  avatar   String?
  active   Boolean  @default(true)

  // OAuth
  googleId        String?   @unique
  authProvider    String    @default("local")
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?

  // Seguridad
  lastLogin        DateTime?
  loginAttempts    Int       @default(0)
  lockedUntil      DateTime?
  twoFactorEnabled Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  twoFactorTokens     TwoFactorToken[]
  auditLogs           AuditLog[]
  certificados        Certificado[]

  @@map("users")
}

model RefreshToken {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  token         String    @unique
  userId        String    @db.ObjectId
  family        String
  expiresAt     DateTime
  isRevoked     Boolean   @default(false)
  ipAddress     String?
  userAgent     String?
  lastUsedAt    DateTime?
  revokedAt     DateTime?
  revokedReason String?
  createdAt     DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  token     String    @unique
  userId    String    @db.ObjectId
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  ipAddress String?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model AuditLog {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  entityType   String
  entityId     String
  action       String
  changes      Json?
  previousData Json?
  newData      Json?
  ip           String?
  userAgent    String?
  createdAt    DateTime @default(now())

  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

model TwoFactorToken {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  userId     String    @db.ObjectId
  code       String
  expiresAt  DateTime
  verified   Boolean   @default(false)
  verifiedAt DateTime?
  attempts   Int       @default(0)
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_tokens")
}

// ============================================
// CERTIFICACIONES
// ============================================

model Certificado {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tipo    String
  nombre  String
  entidad String
  numero  String

  fechaExpedicion  DateTime
  fechaVencimiento DateTime

  archivo       String?
  observaciones String?
  activo        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("certificados")
}

// ============================================
// ÓRDENES DE TRABAJO
// ============================================

model Order {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  numeroOrden String        @unique
  titulo      String
  descripcion String?
  tipo        String
  status      OrderStatus   @default(pendiente)
  subState    OrderSubState @default(solicitud_recibida)
  priority    OrderPriority @default(media)
  
  // Cliente (embebido para mejor rendimiento en MongoDB)
  cliente     ClienteInfo
  
  // Técnico asignado
  tecnicoId   String?       @db.ObjectId
  
  // Creador
  creadoPorId String        @db.ObjectId
  
  // Fechas
  fechaSolicitud   DateTime  @default(now())
  fechaProgramada  DateTime?
  fechaInicio      DateTime?
  fechaFin         DateTime?
  
  // Ubicación
  ubicacion        String?
  coordenadas      Coordenadas?
  
  // Costos
  presupuesto      Float?
  costoReal        Float?
  
  // Flags
  requiereAlturas  Boolean   @default(false)
  tieneGarantia    Boolean   @default(false)
  
  // Cancelación
  canceladoEn      DateTime?
  canceladoPorId   String?   @db.ObjectId
  motivoCancelacion String?
  
  observaciones    String?
  tags             String[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  planeacion           Planeacion?
  ejecucion            Ejecucion?
  evidencias           Evidence[]
  costos               Cost[]
  stateHistory         OrderStateHistory[]
  visitaTecnica        VisitaTecnica?
  propuestaEconomica   PropuestaEconomica?
  alertas              AlertaAutomatica[]
  hojaEntradaServicio  HojaEntradaServicio?
  acta                 Acta?
  ses                  SES?
  factura              Factura?
  cierreAdministrativo CierreAdministrativo?
  equiposHES           OrdenEquipoHES[]
  inspeccionesHES      InspeccionHES[]
  checklists           Checklist[]
  formularios          FormularioInstancia[]

  @@map("orders")
}

// Tipo embebido para cliente
type ClienteInfo {
  nombre    String
  email     String?
  telefono  String?
  empresa   String?
  direccion String?
  nit       String?
}

// Tipo embebido para coordenadas
type Coordenadas {
  lat Float
  lng Float
}

// ============================================
// HISTORIAL DE ESTADOS (14 Pasos)
// ============================================

model OrderStateHistory {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  ordenId      String        @db.ObjectId
  fromState    OrderSubState?
  toState      OrderSubState
  changedById  String?       @db.ObjectId
  motivo       String?
  metadata     Json?
  createdAt    DateTime      @default(now())

  orden Order @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@map("order_state_history")
}

// ============================================
// VISITA TÉCNICA (Paso 2)
// ============================================

model VisitaTecnica {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  ordenId     String   @unique @db.ObjectId
  tecnicoId   String   @db.ObjectId
  
  fechaProgramada DateTime
  fechaRealizada  DateTime?
  
  diagnostico     String?
  hallazgos       String[]
  fotosEvidencia  String[]
  recomendaciones String?
  
  firmaTecnico    String?
  firmaCliente    String?
  
  completada      Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden Order @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@map("visitas_tecnicas")
}

// ============================================
// PROPUESTA ECONÓMICA (Pasos 3-4)
// ============================================

model PropuestaEconomica {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  ordenId     String @unique @db.ObjectId
  
  numero      String @unique
  version     Int    @default(1)
  
  // Items de la propuesta (embebidos)
  items       ItemPropuesta[]
  
  subtotal    Float
  impuestos   Float
  descuento   Float  @default(0)
  total       Float
  
  validezDias Int    @default(30)
  
  condiciones String?
  notas       String?
  
  estado      EstadoPropuesta @default(borrador)
  
  creadoPorId   String?   @db.ObjectId
  aprobadoPorId String?   @db.ObjectId
  rechazadoPorId String?  @db.ObjectId
  
  fechaEnvio      DateTime?
  fechaAprobacion DateTime?
  fechaRechazo    DateTime?
  motivoRechazo   String?
  
  archivoPDF      String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden Order @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@map("propuestas_economicas")
}

type ItemPropuesta {
  descripcion String
  cantidad    Float
  unidad      String
  precioUnit  Float
  subtotal    Float
}

// ============================================
// PLANEACIÓN (Paso 5)
// ============================================

model Planeacion {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  ordenId     String           @unique @db.ObjectId
  estado      EstadoPlaneacion @default(borrador)
  
  // Cronograma
  fechaInicioPlaneada DateTime
  fechaFinPlaneada    DateTime
  horasEstimadas      Float
  
  // Recursos (embebidos)
  recursos            RecursoPlaneacion[]
  tareas              TareaPlaneacion[]
  
  // Aprobaciones
  creadoPorId    String?   @db.ObjectId
  aprobadoPorId  String?   @db.ObjectId
  rechazadoPorId String?   @db.ObjectId
  
  fechaAprobacion DateTime?
  fechaRechazo    DateTime?
  motivoRechazo   String?
  
  observaciones String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden     Order      @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  ejecucion Ejecucion?

  @@map("planeaciones")
}

type RecursoPlaneacion {
  tipo        String  // personal, equipo, material
  descripcion String
  cantidad    Float
  unidad      String?
  asignado    Boolean @default(false)
}

type TareaPlaneacion {
  orden       Int
  descripcion String
  duracionHrs Float
  responsable String?
  completada  Boolean @default(false)
}

// ============================================
// EJECUCIÓN (Paso 6)
// ============================================

model Ejecucion {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId
  ordenId         String          @unique @db.ObjectId
  planeacionId    String          @unique @db.ObjectId
  estado          EstadoEjecucion @default(no_iniciada)
  
  avancePercent   Int      @default(0)
  horasReales     Float    @default(0)
  
  fechaInicio     DateTime?
  fechaFin        DateTime?
  
  // GPS
  ubicacionInicio Coordenadas?
  ubicacionFin    Coordenadas?
  
  iniciadoPorId   String?  @db.ObjectId
  finalizadoPorId String?  @db.ObjectId
  
  observaciones   String?
  sincronizado    Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden      Order       @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  planeacion Planeacion  @relation(fields: [planeacionId], references: [id], onDelete: Cascade)
  
  tareas              TareaEjecucion[]
  checklistsEjecucion ChecklistEjecucion[]
  fotosEvidencia      FotoEvidencia[]

  @@map("ejecuciones")
}

model TareaEjecucion {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  ejecucionId     String    @db.ObjectId
  descripcion     String
  completada      Boolean   @default(false)
  horasEstimadas  Float
  horasReales     Float?
  observaciones   String?
  completadaEn    DateTime?
  completadaPorId String?   @db.ObjectId

  ejecucion Ejecucion @relation(fields: [ejecucionId], references: [id], onDelete: Cascade)

  @@map("tareas_ejecucion")
}

model FotoEvidencia {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  ejecucionId  String?  @db.ObjectId
  url          String
  urlThumbnail String?
  descripcion  String?
  fase         String?  // antes, durante, despues
  tamanoBytes  Int?
  mimeType     String?
  cargadoPorId String?  @db.ObjectId
  cargadoEn    DateTime @default(now())
  sincronizado Boolean  @default(false)

  ejecucion Ejecucion? @relation(fields: [ejecucionId], references: [id], onDelete: SetNull)

  @@map("fotos_evidencia")
}

// ============================================
// CHECKLISTS DINÁMICOS
// ============================================

model ChecklistTemplate {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  nombre      String  @unique
  tipo        String  // hes, inspeccion, mantenimiento, etc.
  categoria   String?
  descripcion String?
  activo      Boolean @default(true)
  
  // Items embebidos para mejor rendimiento
  items       ChecklistItemTemplate[]
  
  creadoPorId String? @db.ObjectId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("checklist_templates")
}

type ChecklistItemTemplate {
  orden       Int
  nombre      String
  descripcion String?
  tipo        String    // boolean, text, number, select
  opciones    String[]  // para tipo select
  requerido   Boolean   @default(false)
  criticidad  String    @default("normal")
}

model Checklist {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  ordenId     String  @db.ObjectId
  templateId  String? @db.ObjectId
  nombre      String
  descripcion String?
  
  // Items con respuestas (embebidos)
  items       ChecklistItemRespuesta[]
  
  completado      Boolean   @default(false)
  completadoPorId String?   @db.ObjectId
  completadoEn    DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden Order @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@map("checklists")
}

type ChecklistItemRespuesta {
  itemId      String
  nombre      String
  tipo        String
  valor       String?
  completado  Boolean  @default(false)
  observacion String?
  foto        String?
}

model ChecklistEjecucion {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  ejecucionId String  @db.ObjectId
  nombre      String
  descripcion String?
  
  items       ChecklistItemRespuesta[]
  
  completado      Boolean   @default(false)
  completadoPorId String?   @db.ObjectId
  completadoEn    DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ejecucion Ejecucion @relation(fields: [ejecucionId], references: [id], onDelete: Cascade)

  @@map("checklist_ejecucion")
}

// ============================================
// EVIDENCIAS
// ============================================

model Evidence {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  ordenId       String       @db.ObjectId
  tipo          TipoEvidencia
  nombreArchivo String
  rutaArchivo   String
  tamano        Int
  mimeType      String       @default("application/octet-stream")
  descripcion   String?
  
  ubicacionGPS  Coordenadas?
  tags          String[]
  
  subidoPorId   String       @db.ObjectId
  
  verificada    Boolean      @default(false)
  verificadoPorId String?    @db.ObjectId
  verificadoEn  DateTime?
  
  thumbnailPath String?
  metadata      Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden Order @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@map("evidencias")
}

// ============================================
// COSTOS
// ============================================

model Cost {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  ordenId     String    @db.ObjectId
  tipo        TipoCosto
  descripcion String
  cantidad    Float
  precioUnit  Float
  subtotal    Float
  
  proveedor   String?
  factura     String?
  fecha       DateTime  @default(now())
  
  creadoPorId String    @db.ObjectId
  aprobado    Boolean   @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden Order @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@map("costos")
}

// ============================================
// CIERRE ADMINISTRATIVO (Pasos 8-14)
// ============================================

model Acta {
  id      String     @id @default(auto()) @map("_id") @db.ObjectId
  numero  String     @unique
  ordenId String     @unique @db.ObjectId
  estado  EstadoActa @default(borrador)
  
  fechaEmision       DateTime @default(now())
  fechaEntrega       DateTime?
  trabajosRealizados String
  observaciones      String?
  
  // Firmas
  firmaTecnico       String?
  firmaCliente       String?
  nombreFirmaTecnico String?
  nombreFirmaCliente String?
  fechaFirma         DateTime?
  
  archivoPDF String?
  adjuntos   String[]
  
  creadoPorId   String? @db.ObjectId
  aprobadoPorId String? @db.ObjectId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden                Order                 @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  cierreAdministrativo CierreAdministrativo?

  @@map("actas")
}

model SES {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  numeroSES String    @unique
  ordenId   String    @unique @db.ObjectId
  estado    EstadoSES @default(no_creada)
  
  fechaCreacion   DateTime  @default(now())
  fechaEnvio      DateTime?
  fechaAprobacion DateTime?
  
  codigoAriba         String?
  numeroPO            String?
  descripcionServicio String
  valorTotal          Float
  observaciones       String?
  
  creadoPorId   String? @db.ObjectId
  aprobadoPorId String? @db.ObjectId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden                Order                 @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  cierreAdministrativo CierreAdministrativo?

  @@map("ses")
}

model Factura {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  numeroFactura String        @unique
  ordenId       String        @unique @db.ObjectId
  estado        EstadoFactura @default(no_creada)
  
  fechaEmision     DateTime  @default(now())
  fechaVencimiento DateTime?
  fechaPago        DateTime?
  
  subtotal   Float
  impuestos  Float
  descuentos Float @default(0)
  valorTotal Float
  
  conceptos     String
  observaciones String?
  archivoPDF    String?
  adjuntos      String[]
  
  creadoPorId   String? @db.ObjectId
  aprobadoPorId String? @db.ObjectId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden                Order                 @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  cierreAdministrativo CierreAdministrativo?

  @@map("facturas")
}

model CierreAdministrativo {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  ordenId String @unique @db.ObjectId
  
  actaId    String? @unique @db.ObjectId
  sesId     String? @unique @db.ObjectId
  facturaId String? @unique @db.ObjectId
  
  porcentajeCompletado Int     @default(0)
  estaCompleto         Boolean @default(false)
  
  fechaInicioCierre   DateTime  @default(now())
  fechaCierreCompleto DateTime?
  
  observaciones String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden   Order    @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  acta    Acta?    @relation(fields: [actaId], references: [id])
  ses     SES?     @relation(fields: [sesId], references: [id])
  factura Factura? @relation(fields: [facturaId], references: [id])

  @@map("cierre_administrativo")
}

// ============================================
// ALERTAS AUTOMÁTICAS
// ============================================

model AlertaAutomatica {
  id           String          @id @default(auto()) @map("_id") @db.ObjectId
  ordenId      String?         @db.ObjectId
  tipo         TipoAlerta
  prioridad    PrioridadAlerta @default(info)
  titulo       String
  mensaje      String
  
  usuarioId    String?  @db.ObjectId
  
  leida        Boolean  @default(false)
  leidaEn      DateTime?
  resuelta     Boolean  @default(false)
  resueltaEn   DateTime?
  resueltaPorId String? @db.ObjectId
  
  metadata     Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden Order? @relation(fields: [ordenId], references: [id], onDelete: SetNull)

  @@map("alertas_automaticas")
}

// ============================================
// HES - SEGURIDAD EN ALTURAS
// ============================================

model HojaEntradaServicio {
  id      String    @id @default(auto()) @map("_id") @db.ObjectId
  numero  String    @unique
  ordenId String    @unique @db.ObjectId
  estado  EstadoHES @default(BORRADOR)
  
  tipoServicio TipoServicio
  prioridad    Prioridad
  nivelRiesgo  NivelRiesgo @default(BAJO)
  
  // Datos embebidos
  clienteInfo             Json
  condicionesEntrada      Json?
  diagnosticoPreliminar   Json?
  requerimientosSeguridad Json?
  
  // Firmas
  firmaCliente     Json?
  firmaTecnico     Json?
  firmadoClienteAt DateTime?
  firmadoTecnicoAt DateTime?
  
  creadoPorId     String    @db.ObjectId
  completadoEn    DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden Order @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@map("hojas_entrada_servicio")
}

model EquipoHES {
  id     String  @id @default(auto()) @map("_id") @db.ObjectId
  numero String  @unique
  codigo String?
  marca  String
  modelo String?
  tipo   String  // arnes, eslinga, escalera, etc.
  estado String  @default("disponible")
  
  fechaCompra      DateTime?
  fechaFabricacion DateTime?
  vidaUtilAnios    Int?
  
  ultimaInspeccion  DateTime?
  proximaInspeccion DateTime?
  
  especificaciones Json?
  observaciones    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inspecciones InspeccionHES[]
  ordenesHES   OrdenEquipoHES[]

  @@map("equipos_hes")
}

model InspeccionHES {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  
  equipoId    String  @db.ObjectId
  inspectorId String  @db.ObjectId
  ordenId     String? @db.ObjectId
  
  fechaInspeccion DateTime @default(now())
  estado          String   // conforme, no_conforme, pendiente
  observaciones   String?
  fotosEvidencia  String[]
  
  // Items de inspección (embebidos)
  items       InspeccionItemHES[]
  
  aprobada   Boolean   @default(false)
  aprobadaEn DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  equipo EquipoHES @relation(fields: [equipoId], references: [id])
  orden  Order?    @relation(fields: [ordenId], references: [id], onDelete: SetNull)

  @@map("inspecciones_hes")
}

type InspeccionItemHES {
  rubro       String
  descripcion String?
  estado      String  // conforme, no_conforme, na
  conforme    Boolean @default(true)
  notas       String?
}

model OrdenEquipoHES {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  ordenId  String @db.ObjectId
  equipoId String @db.ObjectId
  
  cantidad Int    @default(1)
  estado   String @default("asignado")
  
  fechaAsignacion DateTime  @default(now())
  fechaDevolucion DateTime?
  observaciones   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orden  Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  equipo EquipoHES @relation(fields: [equipoId], references: [id])

  @@unique([ordenId, equipoId])
  @@map("orden_equipos_hes")
}

// ============================================
// FORMULARIOS DINÁMICOS
// ============================================

model FormTemplate {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  nombre    String         @unique
  tipo      TipoFormulario
  categoria String
  version   String         @default("1.0")
  activo    Boolean        @default(true)
  
  // Schema JSON para el formulario
  schema    Json
  uiSchema  Json?
  
  descripcion String?
  tags        String[]
  
  creadoPorId String? @db.ObjectId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  instancias FormularioInstancia[]

  @@map("form_templates")
}

model FormularioInstancia {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  templateId String @db.ObjectId
  ordenId    String? @db.ObjectId
  
  // Datos del formulario
  data Json
  
  estado          EstadoFormulario @default(borrador)
  completadoPorId String?          @db.ObjectId
  completadoEn    DateTime?
  revisadoPorId   String?          @db.ObjectId
  revisadoEn      DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  template FormTemplate @relation(fields: [templateId], references: [id])
  orden    Order?       @relation(fields: [ordenId], references: [id])

  @@map("formularios_instancias")
}

// ============================================
// KITS DE HERRAMIENTAS
// ============================================

model KitHerramientas {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  nombre      String  @unique
  descripcion String?
  tipo        String  // preventivo, correctivo, instalacion, etc.
  activo      Boolean @default(true)
  
  // Items embebidos
  items       KitItem[]
  
  creadoPorId String? @db.ObjectId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("kits_herramientas")
}

type KitItem {
  nombre      String
  cantidad    Int
  unidad      String?
  requerido   Boolean @default(true)
  descripcion String?
}

// ============================================
// NOTIFICACIONES PUSH
// ============================================

model PushSubscription {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  userId   String @db.ObjectId
  endpoint String @unique
  p256dh   String
  auth     String
  
  activo   Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("push_subscriptions")
}

// ============================================
// SYNC OFFLINE
// ============================================

model PendingSync {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  entityType  String
  entityId    String
  action      String   // create, update, delete
  payload     Json
  userId      String   @db.ObjectId
  status      String   @default("pending")
  attempts    Int      @default(0)
  lastAttempt DateTime?
  errorMsg    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pending_syncs")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  admin
  supervisor
  tecnico
  administrativo
  gerente
}

enum OrderStatus {
  pendiente
  planeacion
  ejecucion
  completada
  cancelada
  pausada
}

enum OrderPriority {
  baja
  media
  alta
  urgente
}

enum OrderSubState {
  // Solicitud (Pasos 1-4)
  solicitud_recibida
  visita_programada
  propuesta_elaborada
  propuesta_aprobada
  // Planeación (Paso 5)
  planeacion_iniciada
  planeacion_aprobada
  // Ejecución (Paso 6)
  ejecucion_iniciada
  ejecucion_completada
  // Informe (Paso 7)
  informe_generado
  // Cierre Técnico (Pasos 8-9)
  acta_elaborada
  acta_firmada
  // Cierre Administrativo (Pasos 10-13)
  ses_aprobada
  factura_aprobada
  // Final (Paso 14)
  pago_recibido
}

enum EstadoPlaneacion {
  borrador
  en_revision
  aprobada
  en_ejecucion
  completada
  cancelada
}

enum EstadoEjecucion {
  no_iniciada
  en_progreso
  pausada
  completada
  cancelada
}

enum EstadoPropuesta {
  borrador
  enviada
  aprobada
  rechazada
  vencida
}

enum EstadoActa {
  borrador
  generada
  enviada
  firmada
  rechazada
}

enum EstadoSES {
  no_creada
  creada
  enviada
  aprobada
  rechazada
}

enum EstadoFactura {
  no_creada
  generada
  enviada
  aprobada
  pagada
  rechazada
}

enum TipoEvidencia {
  foto
  video
  documento
  audio
  otro
}

enum TipoCosto {
  material
  mano_obra
  equipo
  transporte
  otro
}

enum TipoAlerta {
  acta_sin_firmar
  ses_pendiente
  factura_vencida
  recurso_faltante
  certificacion_vencida
  retraso_cronograma
  propuesta_sin_respuesta
}

enum PrioridadAlerta {
  info
  warning
  error
  critical
}

enum TipoFormulario {
  checklist
  inspeccion
  mantenimiento
  reporte
  certificacion
  hes
  otro
}

enum EstadoFormulario {
  borrador
  en_revision
  completado
  rechazado
}

enum EstadoHES {
  BORRADOR
  COMPLETADO
  ANULADO
}

enum TipoServicio {
  MANTENIMIENTO_PREVENTIVO
  MANTENIMIENTO_CORRECTIVO
  REPARACION
  INSTALACION
  INSPECCION
  DIAGNOSTICO
  GARANTIA
}

enum Prioridad {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum NivelRiesgo {
  BAJO
  MEDIO
  ALTO
  CRITICO
}
