// Prisma Schema para Cermont
// Version 2.0.0

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  admin
  supervisor
  tecnico
  administrativo
}

enum OrderStatus {
  planeacion
  ejecucion
  pausada
  completada
  cancelada
}

enum OrderPriority {
  baja
  media
  alta
  urgente
}

enum EstadoPlaneacion {
  borrador
  en_revision
  aprobada
  en_ejecucion
  completada
  cancelada
}

enum EstadoEjecucion {
  NO_INICIADA
  EN_PROGRESO
  PAUSADA
  COMPLETADA
  CANCELADA
}

enum EstadoInspeccion {
  CONFORME
  NO_CONFORME
  PENDIENTE
}

enum TipoMantenimiento {
  PREVENTIVO
  CORRECTIVO
  PREDICTIVO
}

enum EstadoMantenimiento {
  PROGRAMADO
  EN_PROGRESO
  COMPLETADO
  CANCELADO
  PENDIENTE
}

enum PrioridadMantenimiento {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

enum EstadoActa {
  BORRADOR
  GENERADA
  ENVIADA
  FIRMADA
  RECHAZADA
}

enum EstadoSES {
  NO_CREADA
  CREADA
  ENVIADA
  APROBADA
  RECHAZADA
}

enum EstadoFactura {
  NO_CREADA
  GENERADA
  ENVIADA
  APROBADA
  PAGADA
  RECHAZADA
}

enum TipoArchivo {
  ORDENES_CSV
  EVIDENCIAS_ZIP
  INFORMES_PDF
  BACKUP_COMPLETO
}

// Estado detallado de orden (14 pasos del flujo)
enum OrderSubState {
  // Solicitud (Pasos 1-4)
  SOLICITUD_RECIBIDA        // Paso 1: Cliente solicita servicio
  VISITA_PROGRAMADA         // Paso 2: Visita tÃÂ©cnica programada
  PROPUESTA_ELABORADA       // Paso 3: Propuesta econÃÂ³mica creada
  PROPUESTA_APROBADA        // Paso 4: Cliente aprueba propuesta
  
  // PlaneaciÃÂ³n (Paso 5)
  PLANEACION_INICIADA       // 5.1: Cronograma en elaboraciÃÂ³n
  PLANEACION_APROBADA       // 5.6: PlaneaciÃÂ³n lista
  
  // EjecuciÃÂ³n (Paso 6)
  EJECUCION_INICIADA        // 6.1: Trabajos iniciados
  EJECUCION_COMPLETADA      // 6.5: Trabajos finalizados
  
  // Informe (Paso 7)
  INFORME_GENERADO          // 7: Informe tÃÂ©cnico entregado
  
  // Cierre TÃÂ©cnico (Pasos 8-9)
  ACTA_ELABORADA            // 8: Acta creada
  ACTA_FIRMADA              // 9: Acta firmada por cliente
  
  // Cierre Administrativo (Pasos 10-13)
  SES_APROBADA              // 11: SES aprobada en ARIBA
  FACTURA_APROBADA          // 13: Factura aprobada
  
  // Final (Paso 14)
  PAGO_RECIBIDO             // 14: Pago confirmado
}

enum TipoAlerta {
  ACTA_SIN_FIRMAR           // Acta pendiente de firma >7 dÃÂ­as
  SES_PENDIENTE             // SES sin aprobar >5 dÃÂ­as
  FACTURA_VENCIDA           // Factura sin pagar
  RECURSO_FALTANTE          // Kit incompleto
  CERTIFICACION_VENCIDA     // CertificaciÃÂ³n tÃÂ©cnico prÃÂ³xima a vencer
  RETRASO_CRONOGRAMA        // Actividad retrasada
  PROPUESTA_SIN_RESPUESTA   // Propuesta enviada sin respuesta >15 dÃÂ­as
}

enum PrioridadAlerta {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// ============================================
// MODELS - USUARIOS Y AUTENTICACION
// ============================================

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  googleId  String?   @unique
  password  String
  name      String
  role      UserRole  @default(tecnico)
  phone     String?
  avatar    String?
  active    Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  refreshTokens             RefreshToken[]
  auditLogs                 AuditLog[]
  ordenes                   Order[]                    @relation("OrderCreator")
  asignaciones              Order[]                    @relation("OrderAssignee")
  planeacionesAprobadas     Planeacion[]               @relation("PlaneacionAprobador")
  inspeccionesHESRealizadas InspeccionHES[]
  inspeccionesLineasVida    InspeccionLineaVida[]      @relation("InspectorLineaVida")
  pushSubscriptions         PushSubscription[]
  mantenimientosAsignados   Mantenimiento[]            @relation("MantenimientosTecnico")
  mantenimientosCreados     Mantenimiento[]            @relation("MantenimientosCreador")
  checklistsCompletados     ChecklistEjecucion[]       @relation("ChecklistCompletadoPor")
  checklistItemsCompletados ChecklistItemEjecucion[]   @relation("ItemCompletadoPor")
  fotosCargadas             FotoEvidencia[]            @relation("FotoCargadaPor")
  formulariosCompletados    FormularioInstancia[]      @relation("FormulariosCompletados")
  
  // Nuevas relaciones para flujo 14 pasos
  stateChanges              OrderStateHistory[]        @relation("StateChangeUser")
  visitasRealizadas         VisitaTecnica[]            @relation("VisitaTecnico")
  alertasAsignadas          AlertaAutomatica[]         @relation("AlertaUsuario")

  @@index([role])
  @@index([active])
  @@index([role, active])
  @@index([createdAt(sort: Desc)])
  @@map("users")
}

model RefreshToken {
  id         String    @id @default(uuid())
  token      String    @unique
  userId     String
  family     String
  expiresAt  DateTime
  isRevoked  Boolean   @default(false)
  ipAddress  String?
  userAgent  String?
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

// ============================================
// MODELS - ÃâRDENES DE TRABAJO
// ============================================

model Order {
  id               String        @id @default(uuid())
  numero           String        @unique
  descripcion      String
  cliente          String
  estado           OrderStatus   @default(planeacion)
  subEstado        OrderSubState @default(SOLICITUD_RECIBIDA)
  prioridad        OrderPriority @default(media)
  fechaFinEstimada DateTime?
  fechaInicio      DateTime?
  fechaFin         DateTime?

  presupuestoEstimado Float? @default(0)
  impuestosAplicables Float? @default(0)
  margenUtilidad      Float? @default(0)

  requiereHES     Boolean @default(true)
  cumplimientoHES Boolean @default(false)

  creadorId  String?
  creador    User?   @relation("OrderCreator", fields: [creadorId], references: [id])
  asignadoId String?
  asignado   User?   @relation("OrderAssignee", fields: [asignadoId], references: [id])

  items               OrderItem[]
  evidencias          Evidence[]
  costos              Cost[]
  planeacion          Planeacion?
  ejecucion           Ejecucion?
  evidenciasEjecucion EvidenciaEjecucion[]
  equiposHES          OrdenEquipoHES[]
  inspeccionesHES     InspeccionHES[]

  acta                  Acta?
  ses                   SES?
  factura               Factura?
  cierreAdministrativo  CierreAdministrativo?
  formularioInstancias  FormularioInstancia[]

  // Nuevas relaciones para flujo 14 pasos
  visitas       VisitaTecnica[]
  propuesta     PropuestaEconomica?
  stateHistory  OrderStateHistory[]
  comparativa   ComparativaCostos?
  alertas       AlertaAutomatica[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([estado])
  @@index([subEstado])
  @@index([cliente])
  @@index([numero])
  @@index([creadorId])
  @@index([asignadoId])
  @@index([prioridad])
  @@index([fechaInicio])
  @@index([createdAt(sort: Desc)])
  @@index([estado, fechaInicio])
  @@index([asignadoId, estado])
  @@index([cliente, estado])
  @@index([estado, prioridad, fechaInicio])
  @@map("orders")
}

model OrderItem {
  id          String  @id @default(uuid())
  descripcion String
  cantidad    Int     @default(1)
  completado  Boolean @default(false)
  notas       String?

  orderId String
  orden   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@map("order_items")
}

model Evidence {
  id          String  @id @default(uuid())
  tipo        String
  url         String
  descripcion String?

  orderId String
  orden   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([tipo])
  @@index([createdAt(sort: Desc)])
  @@map("evidences")
}

model Cost {
  id          String  @id @default(uuid())
  concepto    String
  monto       Float
  tipo        String
  descripcion String?

  orderId String
  orden   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([tipo])
  @@index([createdAt(sort: Desc)])
  @@map("costs")
}

model AuditLog {
  id         String   @id @default(uuid())
  entityType String
  entityId   String
  action     String
  changes    Json?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@map("audit_logs")
}

// ============================================
// PLANEACIÃâN Y KITS TÃÂPICOS
// ============================================

model KitTipico {
  id                    String   @id @default(uuid())
  nombre                String   @unique
  descripcion           String
  herramientas          Json
  equipos               Json
  documentos            String[]
  checklistItems        String[]
  duracionEstimadaHoras Int
  costoEstimado         Float
  activo                Boolean  @default(true)

  planeaciones Planeacion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("kits_tipicos")
}

model Planeacion {
  id     String           @id @default(uuid())
  estado EstadoPlaneacion @default(borrador)

  empresa             String?
  ubicacion           String?
  fechaEstimadaInicio DateTime?
  fechaEstimadaFin    DateTime?
  descripcionTrabajo  String?

  cronograma              Json
  manoDeObra              Json
  herramientasAdicionales Json?
  documentosApoyo         String[]
  observaciones           String?
  aprobadoPorId           String?
  fechaAprobacion         DateTime?

  ordenId String @unique
  orden   Order  @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  kitId String?
  kit   KitTipico? @relation(fields: [kitId], references: [id])

  aprobadoPor User? @relation("PlaneacionAprobador", fields: [aprobadoPorId], references: [id])

  ejecucion Ejecucion?
  items     ItemPlaneacion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ordenId])
  @@index([kitId])
  @@index([estado])
  @@index([aprobadoPorId])
  @@map("planeaciones")
}

model ItemPlaneacion {
  id            String  @id @default(uuid())
  planeacionId  String
  tipo          String
  descripcion   String
  cantidad      Int     @default(1)
  unidad        String  @default("UND")
  observaciones String?

  planeacion Planeacion @relation(fields: [planeacionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planeacionId])
  @@index([tipo])
  @@map("items_planeacion")
}

// ============================================
// EJECUCIÃâN Y SEGUIMIENTO
// ============================================

model Ejecucion {
  id                  String          @id @default(uuid())
  ordenId             String          @unique
  planeacionId        String          @unique
  estado              EstadoEjecucion @default(NO_INICIADA)
  avancePercentaje    Int             @default(0)
  horasActuales       Float           @default(0)
  horasEstimadas      Float
  fechaInicio         DateTime
  fechaTermino        DateTime?
  ubicacionGPS        Json?
  observacionesInicio String?
  observaciones       String?
  sincronizado        Boolean         @default(false)

  orden               Order                @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  planeacion          Planeacion           @relation(fields: [planeacionId], references: [id])
  tareas              TareaEjecucion[]
  checklists          ChecklistEjecucion[]
  evidenciasEjecucion EvidenciaEjecucion[]
  fotosEvidencia      FotoEvidencia[]      @relation("EjecucionFotos")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ordenId])
  @@index([planeacionId])
  @@index([estado])
  @@map("ejecuciones")
}

model TareaEjecucion {
  id             String    @id @default(uuid())
  ejecucionId    String
  descripcion    String
  completada     Boolean   @default(false)
  horasEstimadas Float
  horasReales    Float?
  observaciones  String?
  completadaEn   DateTime?

  ejecucion Ejecucion @relation(fields: [ejecucionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ejecucionId])
  @@map("tareas_ejecucion")
}

// ============================================
// CHECKLISTS - TEMPLATES Y EJECUCIÃâN
// ============================================

model ChecklistTemplate {
  id          String                  @id @default(uuid())
  nombre      String
  tipo        String
  descripcion String?
  activo      Boolean                 @default(true)
  items       ChecklistTemplateItem[]
  checklists  ChecklistEjecucion[]    @relation("TemplateChecklistEjecucion")
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@index([tipo, activo])
  @@map("checklist_templates")
}

model ChecklistTemplateItem {
  id                   String                   @id @default(uuid())
  templateId           String
  template             ChecklistTemplate        @relation(fields: [templateId], references: [id], onDelete: Cascade)
  nombre               String
  descripcion          String?
  tipo                 String
  requereCertificacion Boolean                  @default(false)
  orden                Int                      @default(0)
  createdAt            DateTime                 @default(now())
  itemsEjecucion       ChecklistItemEjecucion[] @relation("TemplateItemRef")

  @@index([templateId])
  @@map("checklist_template_items")
}

model ChecklistEjecucion {
  id              String    @id @default(uuid())
  ejecucionId     String
  templateId      String?
  nombre          String
  descripcion     String?
  completada      Boolean   @default(false)
  completadoPorId String?
  completadoEn    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  ejecucion     Ejecucion              @relation(fields: [ejecucionId], references: [id], onDelete: Cascade)
  template      ChecklistTemplate?     @relation("TemplateChecklistEjecucion", fields: [templateId], references: [id])
  completadoPor User?                  @relation("ChecklistCompletadoPor", fields: [completadoPorId], references: [id])
  items         ChecklistItemEjecucion[]
  fotosEvidencia FotoEvidencia[]       @relation("ChecklistFotos")

  @@index([ejecucionId])
  @@index([templateId])
  @@index([completadoPorId])
  @@map("checklist_ejecucion")
}

model ChecklistItemEjecucion {
  id              String    @id @default(uuid())
  checklistId     String
  templateItemId  String?
  nombre          String
  estado          String    @default("pendiente")
  completado      Boolean   @default(false)
  completadoPorId String?
  completadoEn    DateTime?
  observaciones   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  checklist     ChecklistEjecucion     @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  templateItem  ChecklistTemplateItem? @relation("TemplateItemRef", fields: [templateItemId], references: [id])
  completadoPor User?                  @relation("ItemCompletadoPor", fields: [completadoPorId], references: [id])
  fotosAdjuntas FotoEvidencia[]        @relation("ItemFotos")

  @@index([checklistId])
  @@index([templateItemId])
  @@index([completadoPorId])
  @@map("checklist_item_ejecucion")
}

model FotoEvidencia {
  id              String    @id @default(uuid())
  ejecucionId     String?
  checklistId     String?
  checklistItemId String?
  url             String
  descripcion     String?
  fase            String?
  cargadoPorId    String?
  cargadoEn       DateTime  @default(now())
  sincronizado    Boolean   @default(false)

  ejecucion     Ejecucion?              @relation("EjecucionFotos", fields: [ejecucionId], references: [id], onDelete: SetNull)
  checklist     ChecklistEjecucion?     @relation("ChecklistFotos", fields: [checklistId], references: [id], onDelete: SetNull)
  checklistItem ChecklistItemEjecucion? @relation("ItemFotos", fields: [checklistItemId], references: [id], onDelete: SetNull)
  cargadoPor    User?                   @relation("FotoCargadaPor", fields: [cargadoPorId], references: [id])

  @@index([ejecucionId])
  @@index([checklistId])
  @@index([checklistItemId])
  @@index([cargadoPorId])
  @@map("fotos_evidencia")
}

model EvidenciaEjecucion {
  id            String   @id @default(uuid())
  ejecucionId   String
  ordenId       String
  tipo          String
  nombreArchivo String
  rutaArchivo   String
  tamano        Int
  mimeType      String   @default("application/octet-stream")
  descripcion   String
  ubicacionGPS  Json?
  tags          String[]
  subidoPor     String
  verificada    Boolean  @default(false)
  verificadoPor String?
  verificadoEn  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  ejecucion Ejecucion @relation(fields: [ejecucionId], references: [id], onDelete: Cascade)
  orden     Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@index([ejecucionId])
  @@index([ordenId])
  @@map("evidencias_ejecucion")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  auth      String
  p256dh    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

// ============================================
// INSPECCIÃâN LÃÂNEAS DE VIDA
// ============================================

model InspeccionLineaVida {
  id               String @id @default(uuid())
  numeroLinea      String @unique
  fabricante       String
  diametroCable    String @default("8mm")
  tipoCable        String @default("Acero Inoxidable")
  ubicacion        String
  especificaciones Json?

  fechaInspeccion          DateTime  @default(now())
  fechaInstalacion         DateTime?
  fechaUltimoMantenimiento DateTime?

  estado              EstadoInspeccion @default(PENDIENTE)
  accionesCorrectivas String?
  observaciones       String?
  fotosEvidencia      String[]

  inspectorId String
  inspector   User   @relation("InspectorLineaVida", fields: [inspectorId], references: [id])

  componentes ComponenteLineaVida[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([numeroLinea])
  @@index([inspectorId])
  @@index([estado])
  @@map("inspecciones_linea_vida")
}

model ComponenteLineaVida {
  id               String  @id @default(uuid())
  inspeccionId     String
  nombre           String
  hallazgos        String?
  estado           String
  accionCorrectiva String?

  condiciones CondicionComponente[]

  inspeccion InspeccionLineaVida @relation(fields: [inspeccionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([inspeccionId])
  @@map("componentes_linea_vida")
}

model CondicionComponente {
  id           String @id @default(uuid())
  componenteId String
  tipoAfeccion String
  descripcion  String
  estado       String

  componente ComponenteLineaVida @relation(fields: [componenteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([componenteId])
  @@map("condiciones_componente")
}

// ============================================
// HES - SEGURIDAD EN ALTURAS
// ============================================

model EquipoHES {
  id     String @id @default(uuid())
  numero String @unique
  marca  String
  tipo   String
  estado String @default("DISPONIBLE")

  ultimaInspeccion  DateTime?
  proximaInspeccion DateTime?

  especificaciones Json?

  inspecciones InspeccionHES[]
  ordenes      OrdenEquipoHES[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([estado])
  @@index([tipo])
  @@map("equipos_hes")
}

model InspeccionHES {
  id String @id @default(uuid())

  equipoId String
  equipo   EquipoHES @relation(fields: [equipoId], references: [id])

  inspectorId String
  inspector   User   @relation(fields: [inspectorId], references: [id])

  ordenId String?
  orden   Order?  @relation(fields: [ordenId], references: [id])

  fechaInspeccion DateTime @default(now())

  items InspeccionItem[]

  estado         String
  observaciones  String?
  fotosEvidencia String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([equipoId])
  @@index([inspectorId])
  @@index([ordenId])
  @@index([estado])
  @@map("inspecciones_hes")
}

model InspeccionItem {
  id String @id @default(uuid())

  inspeccionId String
  inspeccion   InspeccionHES @relation(fields: [inspeccionId], references: [id], onDelete: Cascade)

  rubro       String
  descripcion String?

  estado String
  notas  String?

  @@index([inspeccionId])
  @@map("inspeccion_items")
}

model OrdenEquipoHES {
  id      String @id @default(uuid())
  ordenId String
  orden   Order  @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  equipoId String
  equipo   EquipoHES @relation(fields: [equipoId], references: [id])

  cantidad Int    @default(1)
  estado   String @default("ASIGNADO")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ordenId, equipoId])
  @@index([ordenId])
  @@index([equipoId])
  @@map("orden_equipos_hes")
}

// ============================================
// MANTENIMIENTOS
// ============================================

model Equipo {
  id                         String    @id @default(uuid())
  codigo                     String    @unique
  nombre                     String
  marca                      String?
  modelo                     String?
  serie                      String?
  ubicacion                  String?
  fechaAdquisicion           DateTime?
  fechaUltimoMantenimiento   DateTime?
  intervaloMantenimientoDias Int?
  activo                     Boolean   @default(true)
  notas                      String?

  creadoPorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mantenimientos Mantenimiento[]

  @@index([codigo])
  @@index([activo])
  @@map("equipos")
}

model Mantenimiento {
  id String @id @default(uuid())

  equipoId String
  equipo   Equipo @relation(fields: [equipoId], references: [id], onDelete: Cascade)

  tipo      TipoMantenimiento
  estado    EstadoMantenimiento    @default(PROGRAMADO)
  prioridad PrioridadMantenimiento @default(MEDIA)

  titulo      String
  descripcion String?

  fechaProgramada DateTime
  fechaInicio     DateTime?
  fechaFin        DateTime?

  tecnicoAsignadoId String?
  tecnicoAsignado   User?   @relation("MantenimientosTecnico", fields: [tecnicoAsignadoId], references: [id])

  estimacionHoras Float?
  horasReales     Float?
  costoTotal      Float?

  notas               String?
  observaciones       String?
  trabajoRealizado    String?
  repuestosUtilizados String?

  esRecurrente         Boolean @default(false)
  frecuenciaDias       Int?
  mantenimientoPadreId String?

  creadoPorId      String?
  creadoPor        User?   @relation("MantenimientosCreador", fields: [creadoPorId], references: [id])
  actualizadoPorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([equipoId])
  @@index([estado])
  @@index([fechaProgramada])
  @@index([tecnicoAsignadoId])
  @@index([creadoPorId])
  @@map("mantenimientos")
}

// ============================================
// FORMULARIOS DINAMICOS
// ============================================

model FormularioTemplate {
  id          String  @id @default(uuid())
  nombre      String
  descripcion String?
  schema      String
  version     Int     @default(1)
  activo      Boolean @default(true)

  creadoPorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  respuestas FormularioRespuesta[]

  @@index([activo])
  @@map("formulario_templates")
}

model FormularioRespuesta {
  id String @id @default(uuid())

  templateId String
  template   FormularioTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  ordenId String?

  respuestas String

  completadoPorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@index([ordenId])
  @@map("formulario_respuestas")
}

// ============================================
// CIERRE ADMINISTRATIVO
// ============================================

model Acta {
  id      String @id @default(uuid())
  numero  String @unique
  ordenId String @unique
  orden   Order  @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  estado EstadoActa @default(BORRADOR)

  fechaEmision       DateTime  @default(now())
  fechaEntrega       DateTime?
  trabajosRealizados String
  observaciones      String?

  firmaTecnico       String?
  firmaCliente       String?
  nombreFirmaTecnico String?
  nombreFirmaCliente String?
  cedulaFirmaTecnico String?
  cedulaFirmaCliente String?
  fechaFirma         DateTime?

  archivoActaPDF String?
  adjuntos       String[]

  alertaEnviada Boolean @default(false)
  diasSinFirmar Int     @default(0)

  creadoPorId   String?
  aprobadoPorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cierreAdministrativo CierreAdministrativo?

  @@index([ordenId])
  @@index([estado])
  @@index([numero])
  @@map("actas")
}

model SES {
  id        String @id @default(uuid())
  numeroSES String @unique
  ordenId   String @unique
  orden     Order  @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  estado EstadoSES @default(NO_CREADA)

  fechaCreacion   DateTime  @default(now())
  fechaEnvio      DateTime?
  fechaAprobacion DateTime?

  codigoAriba String?
  urlAriba    String?

  descripcionServicio String
  valorTotal          Float
  observaciones       String?

  alertaEnviada  Boolean @default(false)
  diasSinAprobar Int     @default(0)

  creadoPorId   String?
  aprobadoPorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cierreAdministrativo CierreAdministrativo?

  @@index([ordenId])
  @@index([estado])
  @@index([numeroSES])
  @@map("ses")
}

model Factura {
  id            String @id @default(uuid())
  numeroFactura String @unique
  ordenId       String @unique
  orden         Order  @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  estado EstadoFactura @default(NO_CREADA)

  fechaEmision     DateTime  @default(now())
  fechaVencimiento DateTime?
  fechaAprobacion  DateTime?
  fechaPago        DateTime?

  subtotal   Float
  impuestos  Float
  valorTotal Float

  conceptos     String
  observaciones String?

  archivoFacturaPDF String?
  adjuntos          String[]

  codigoAriba String?
  urlAriba    String?

  alertaEnviada Boolean @default(false)
  diasVencidos  Int     @default(0)

  creadoPorId   String?
  aprobadoPorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cierreAdministrativo CierreAdministrativo?

  @@index([ordenId])
  @@index([estado])
  @@index([numeroFactura])
  @@map("facturas")
}

model CierreAdministrativo {
  id      String @id @default(uuid())
  ordenId String @unique
  orden   Order  @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  actaId String? @unique
  acta   Acta?   @relation(fields: [actaId], references: [id])

  sesId String? @unique
  ses   SES?    @relation(fields: [sesId], references: [id])

  facturaId String?  @unique
  factura   Factura? @relation(fields: [facturaId], references: [id])

  porcentajeCompletado Int     @default(0)
  estaCompleto         Boolean @default(false)

  fechaInicioOrden    DateTime
  fechaFinOrden       DateTime?
  fechaInicioCierre   DateTime  @default(now())
  fechaCierreCompleto DateTime?

  diasParaCierre Int @default(0)

  observaciones String?
  bloqueos      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ordenId])
  @@index([estaCompleto])
  @@map("cierre_administrativo")
}

// ============================================
// ARCHIVO HISTÃâRICO
// ============================================

model ArchivoHistorico {
  id   String      @id @default(uuid())
  tipo TipoArchivo

  mes  Int
  anio Int

  nombreArchivo String
  rutaArchivo   String
  tamanioBytes  BigInt

  cantidadOrdenes    Int     @default(0)
  cantidadEvidencias Int     @default(0)
  descripcion        String?

  disponible    Boolean   @default(true)
  descargado    Boolean   @default(false)
  fechaDescarga DateTime?

  creadoPorId    String?
  fechaArchivado DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mes, anio, tipo])
  @@index([mes, anio])
  @@index([disponible])
  @@map("archivos_historicos")
}

// ============================================
// MODELOS ADICIONALES - KITS Y SINCRONIZACIÃâN
// ============================================

// Modelo Kit (usado en kits.repository.ts)
model Kit {
  id          String    @id @default(uuid())
  nombre      String
  descripcion String?
  categoria   String?
  activo      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  items KitItem[]

  @@map("kits")
}

model KitItem {
  id       String @id @default(uuid())
  kitId    String
  nombre   String
  cantidad Int    @default(1)
  unidad   String @default("UND")

  kit Kit @relation(fields: [kitId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kitId])
  @@map("kit_items")
}

// Modelo Formulario (usado en formularios.repository.ts)
model Formulario {
  id          String  @id @default(uuid())
  nombre      String
  descripcion String?
  categoria   String?
  campos      Json
  activo      Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  respuestas FormularioRespuestaLegacy[]

  @@map("formularios")
}

model FormularioRespuestaLegacy {
  id           String     @id @default(uuid())
  formularioId String
  ordenId      String?
  respuestas   Json
  creadoPorId  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  formulario Formulario @relation(fields: [formularioId], references: [id], onDelete: Cascade)

  @@index([formularioId])
  @@index([ordenId])
  @@map("formulario_respuestas_legacy")
}

// Modelo HES adicional (usado en hes.repository.ts)
model HES {
  id            String   @id @default(uuid())
  equipoId      String?
  ordenId       String?
  tipo          String
  resultados    Json?
  observaciones String?
  aprobado      Boolean  @default(false)
  inspectorId   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("hes_registros")
}

// Modelo LineaVida (usado en lineas-vida.repository.ts)
model LineaVida {
  id                       String    @id @default(uuid())
  ubicacion                String
  tipo                     String?
  longitud                 Float?
  capacidadUsuarios        Int?
  fechaInstalacion         DateTime?
  fechaProximaInspeccion   DateTime?
  observaciones            String?
  estado                   String    @default("activo")
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  inspecciones InspeccionLineaVidaLegacy[]

  @@map("lineas_vida")
}

model InspeccionLineaVidaLegacy {
  id            String     @id @default(uuid())
  lineaVidaId   String
  tipo          String?
  resultados    Json?
  aprobado      Boolean    @default(false)
  observaciones String?
  inspectorId   String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  lineaVida LineaVida @relation(fields: [lineaVidaId], references: [id], onDelete: Cascade)

  @@index([lineaVidaId])
  @@map("inspecciones_linea_vida_legacy")
}

// Modelo PendingSync (usado en sync.repository.ts)
model PendingSync {
  id         String   @id @default(uuid())
  userId     String
  deviceId   String?
  entityType String
  entityId   String?
  action     String
  data       Json?
  localId    String?
  timestamp  DateTime
  status     String   @default("pending")
  error      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("pending_syncs")
}

// ============================================
// DYNAMIC FORMS ENGINE
// ============================================

enum TipoFormulario {
  CHECKLIST
  INSPECCION
  MANTENIMIENTO
  REPORTE
  CERTIFICACION
  HES
  OTRO
}

/// Template de formulario dinÃÂ¡mico
/// Define la estructura y campos de un formulario reutilizable
model FormTemplate {
  id          String         @id @default(uuid())
  nombre      String         @unique
  tipo        TipoFormulario
  categoria   String         // "HES", "LÃÂ­neas de Vida", "CCTV", etc.
  version     String         @default("1.0")
  activo      Boolean        @default(true)

  // JSON Schema completo del formulario
  schema      Json           // Estructura de secciones y campos
  uiSchema    Json?          // ConfiguraciÃÂ³n UI opcional (colores, layout, etc.)

  // Metadata
  descripcion String?
  tags        String[]

  // Relaciones
  instancias  FormularioInstancia[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([tipo, activo])
  @@index([categoria])
  @@map("form_templates")
}

/// Instancia de un formulario completado
/// Almacena los datos capturados para un formulario especÃÂ­fico
model FormularioInstancia {
  id              String        @id @default(uuid())
  templateId      String
  template        FormTemplate  @relation(fields: [templateId], references: [id])

  // RelaciÃÂ³n con orden (opcional)
  ordenId         String?
  orden           Order?        @relation(fields: [ordenId], references: [id])

  // Datos capturados del formulario
  data            Json          // Respuestas del formulario en JSON

  // Quien completÃÂ³ el formulario
  completadoPorId String?
  completadoPor   User?         @relation("FormulariosCompletados", fields: [completadoPorId], references: [id])
  completadoEn    DateTime?

  // Estado
  estado          String        @default("borrador") // borrador, completado, validado

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([templateId])
  @@index([ordenId])
  @@index([completadoPorId])
  @@map("formularios_instancias")
}

// ============================================
// MODELS - FLUJO 14 PASOS / STATE MACHINE
// ============================================

model OrderStateHistory {
  id          String         @id @default(uuid())
  ordenId     String
  orden       Order          @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  fromState   OrderSubState?
  toState     OrderSubState
  
  userId      String?
  user        User?          @relation("StateChangeUser", fields: [userId], references: [id])
  
  notas       String?
  metadata    Json?          // Datos adicionales del cambio
  
  createdAt   DateTime       @default(now())
  
  @@index([ordenId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("order_state_history")
}

model VisitaTecnica {
  id                String    @id @default(uuid())
  ordenId           String
  orden             Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  fechaProgramada   DateTime
  fechaRealizada    DateTime?
  duracionMinutos   Int?
  
  tecnicoId         String
  tecnico           User      @relation("VisitaTecnico", fields: [tecnicoId], references: [id])
  
  // Datos recolectados en visita
  mediciones        Json?     // Medidas tomadas en campo
  fotosUrl          String[]  // URLs de fotos tomadas
  observaciones     String?
  coordenadas       Json?     // {lat, lng}
  
  completada        Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([ordenId])
  @@index([tecnicoId])
  @@index([fechaProgramada])
  @@map("visitas_tecnicas")
}

model PropuestaEconomica {
  id                  String    @id @default(uuid())
  ordenId             String    @unique
  orden               Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  // Costos estimados desglosados
  costoManoObra       Float     @default(0)
  costoMateriales     Float     @default(0)
  costoEquipos        Float     @default(0)
  costoTransporte     Float     @default(0)
  otrosCostos         Float     @default(0)
  
  // CÃÂ¡lculos
  subtotal            Float     @default(0)
  impuestos           Float     @default(0)  // IVA + otros
  margenUtilidad      Float     @default(0)  // % de ganancia
  total               Float     @default(0)  // Total a facturar
  
  // Estado de la propuesta
  numeroVersion       Int       @default(1)
  aprobada            Boolean   @default(false)
  numeroPO            String?   // Purchase Order del cliente
  fechaEnvio          DateTime?
  fechaAprobacion     DateTime?
  fechaRechazo        DateTime?
  motivoRechazo       String?
  
  // Archivo PDF de la propuesta
  urlArchivo          String?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@index([ordenId])
  @@map("propuestas_economicas")
}

model AlertaAutomatica {
  id            String          @id @default(uuid())
  tipo          TipoAlerta
  prioridad     PrioridadAlerta @default(INFO)
  
  ordenId       String
  orden         Order           @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  titulo        String
  mensaje       String
  
  usuarioId     String?
  usuario       User?           @relation("AlertaUsuario", fields: [usuarioId], references: [id])
  
  leida         Boolean         @default(false)
  resuelta      Boolean         @default(false)
  
  metadata      Json?           // Datos adicionales
  
  createdAt     DateTime        @default(now())
  leidaAt       DateTime?
  resueltaAt    DateTime?
  
  @@index([usuarioId, leida])
  @@index([tipo, createdAt(sort: Desc)])
  @@index([ordenId])
  @@index([prioridad, resuelta])
  @@map("alertas_automaticas")
}

model ComparativaCostos {
  id              String    @id @default(uuid())
  ordenId         String    @unique
  orden           Order     @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  
  // Estimados (de la propuesta)
  estimadoManoObra      Float   @default(0)
  estimadoMateriales    Float   @default(0)
  estimadoEquipos       Float   @default(0)
  estimadoTransporte    Float   @default(0)
  estimadoOtros         Float   @default(0)
  totalEstimado         Float   @default(0)
  
  // Reales (de la ejecuciÃÂ³n)
  realManoObra          Float   @default(0)
  realMateriales        Float   @default(0)
  realEquipos           Float   @default(0)
  realTransporte        Float   @default(0)
  realOtros             Float   @default(0)
  totalReal             Float   @default(0)
  
  // Varianza calculada
  varianzaPorcentaje    Float   @default(0)
  margenRealizado       Float   @default(0)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([ordenId])
  @@map("comparativa_costos")
}
