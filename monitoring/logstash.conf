# ============================================
# Logstash Configuration - Cermont FSM
# ============================================

input {
  # Recibir logs del backend via TCP
  tcp {
    port => 5000
    codec => json
  }

  # Logs de Docker via UDP
  udp {
    port => 5000
    codec => json
  }
}

filter {
  # Parse logs de Node.js
  if [type] == "nodejs" {
    json {
      source => "message"
    }
  }

  # Agregar timestamp correcto
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }

  # Enriquecer con informaciÃ³n adicional
  mutate {
    add_field => { "environment" => "production" }
    remove_field => [ "message" ]
  }

  # Agregar GeoIP si hay IP del cliente
  if [client_ip] {
    geoip {
      source => "client_ip"
    }
  }

  # Parsear user agent
  if [user_agent] {
    useragent {
      source => "user_agent"
      target => "ua"
    }
  }
}

output {
  # Enviar a Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "cermont-logs-%{+YYYY.MM.dd}"
  }

  # TambiÃ©n en stdout para debugging
  stdout {
    codec => rubydebug
  }
}
