#!/bin/bash

# ??????????????????????????????????????????????????????
# ?  CERMONT ATG - Script de Producción               ?
# ?  Inicia Backend y Frontend con PM2                ?
# ??????????????????????????????????????????????????????

set -e

# Colores
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Funciones
log_info() {
    echo -e "${CYAN}?${NC} $1"
}

log_success() {
    echo -e "${GREEN}?${NC} $1"
}

log_error() {
    echo -e "${RED}?${NC} $1"
}

# Banner
echo ""
echo -e "${CYAN}??????????????????????????????????????????????????????${NC}"
echo -e "${CYAN}?  ?? CERMONT ATG - PRODUCCIÓN                     ?${NC}"
echo -e "${CYAN}??????????????????????????????????????????????????????${NC}"
echo ""

# Verificar PM2
log_info "Verificando PM2..."
if ! command -v pm2 &> /dev/null; then
    log_error "PM2 no está instalado"
    log_info "Instalando PM2 globalmente..."
    npm install -g pm2
fi
log_success "PM2 encontrado"
echo ""

# Compilar
log_info "Compilando aplicaciones..."
npm run build
log_success "Compilación completada"
echo ""

# Backend
log_info "Iniciando Backend..."
pm2 start "npm run start:backend -w backend" --name "cermont-backend"
log_success "Backend iniciado"

sleep 1

# Frontend
log_info "Iniciando Frontend..."
pm2 start "npm run start:frontend -w frontend" --name "cermont-frontend"
log_success "Frontend iniciado"

echo ""
log_info "Guardando configuración PM2..."
pm2 save
log_success "Configuración guardada"

echo ""
log_info "Configurando startup automático..."
pm2 startup
log_success "Startup configurado"

echo ""
log_success "? Aplicación iniciada en producción"
log_info "Servicios disponibles:"
echo "   ?? Frontend:  http://localhost:3000"
echo "   ?? Backend:   http://localhost:5000"
echo ""

pm2 status
