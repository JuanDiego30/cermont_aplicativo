name: ðŸ•µï¸ Quality & Security Audit Report

on:
  push:
    branches: [main, master, chore/*]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0' # Weekly on Sundays at 2 AM UTC

jobs:
  audit:
    name: Full Stack Audit
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # ========================================================================
      # 1. SETUP
      # ========================================================================

      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.x
          run_install: false

      - name: ðŸ’¾ Setup pnpm Cache
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      # ========================================================================
      # 2. PRE-BUILD: PRISMA GENERATION
      # ========================================================================

      - name: ðŸ—ï¸ Generate Prisma Client
        run: cd backend && pnpm run prisma:generate
        continue-on-error: true

      # ========================================================================
      # 3. LINTING (Capture Errors)
      # ========================================================================

      - name: ðŸŽ¨ Lint Backend
        run: |
          mkdir -p audit
          pnpm -C backend run lint 2>&1 | tee audit/lint-backend.log || true
        continue-on-error: true

      - name: ðŸŽ¨ Lint Frontend
        run: |
          pnpm -C frontend run lint 2>&1 | tee audit/lint-frontend.log || true
        continue-on-error: true

      # ========================================================================
      # 4. TYPE CHECKING
      # ========================================================================

      - name: ðŸ“ Backend Type Check
        run: |
          cd backend && pnpm exec tsc --noEmit 2>&1 | tee ../audit/typecheck-backend.log || true
        continue-on-error: true

      - name: ðŸ“ Frontend Type Check
        run: |
          cd frontend && pnpm exec tsc --noEmit 2>&1 | tee ../audit/typecheck-frontend.log || true
        continue-on-error: true

      # ========================================================================
      # 5. BUILD TEST
      # ========================================================================

      - name: ðŸ—ï¸ Build Backend
        run: |
          pnpm -C backend run build 2>&1 | tee audit/build-backend.log || true
        continue-on-error: true

      - name: ðŸ—ï¸ Build Frontend
        run: |
          pnpm -C frontend run build 2>&1 | tee audit/build-frontend.log || true
        continue-on-error: true

      # ========================================================================
      # 6. CODE DUPLICATION (JSCPD)
      # ========================================================================

      - name: ðŸ‘¯ Code Duplication Analysis
        run: |
          pnpm exec jscpd . --threshold 2.5 --reporters console,html,json 2>&1 | tee audit/duplication.log || true
        continue-on-error: true

      - name: ðŸ“Š Copy Duplication Report
        if: always()
        run: |
          if [ -f "jscpd-report.html" ]; then
            cp jscpd-report.html audit/jscpd-report.html
          fi
        shell: bash

      # ========================================================================
      # 7. API COHERENCE CHECK
      # ========================================================================

      - name: ðŸ”Œ API Coherence Check
        run: |
          node scripts/audit/check-api-consistency.js 2>&1 | tee audit/api-consistency.log || true
        continue-on-error: true

      # ========================================================================
      # 8. SECURITY AUDIT
      # ========================================================================

      - name: ðŸ›¡ï¸ Security Audit (pnpm audit)
        run: |
          pnpm audit --prod --json 2>&1 | tee audit/security-audit.log || true
        continue-on-error: true

      - name: ðŸ“‹ Dependency Check (Outdated)
        run: |
          pnpm outdated --json 2>&1 | tee audit/outdated.log || true
        continue-on-error: true

      # ========================================================================
      # 9. TEST EXECUTION (if tests exist)
      # ========================================================================

      - name: âœ… Backend Tests
        run: |
          pnpm -C backend run test 2>&1 | tee audit/test-backend.log || true
        continue-on-error: true

      - name: âœ… Frontend Tests
        run: |
          pnpm -C frontend run test 2>&1 | tee audit/test-frontend.log || true
        continue-on-error: true

      # ========================================================================
      # 10. GENERATE CONSOLIDATED REPORT
      # ========================================================================

      - name: ðŸ“Š Generate Audit Report
        if: always()
        run: |
          node scripts/generate-audit-report.mjs
        continue-on-error: true

      - name: ðŸ“ Display Report
        if: always()
        run: |
          echo "=== AUDIT REPORT GENERATED ==="
          echo ""
          if [ -f "docs/AUDIT_REPORT.md" ]; then
            cat docs/AUDIT_REPORT.md
          else
            echo "Report generation had issues"
          fi
        shell: bash

      # ========================================================================
      # 11. UPLOAD ARTIFACTS
      # ========================================================================

      - name: ðŸ“¦ Upload Audit Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-logs
          path: audit/
          retention-days: 30

      - name: ðŸ“¦ Upload Audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: docs/AUDIT_REPORT.md
          retention-days: 30

      # ========================================================================
      # 12. POST COMMENT ON PR (if PR)
      # ========================================================================

      - name: ðŸ’¬ Post Report on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'docs/AUDIT_REPORT.md';

            if (!fs.existsSync(reportPath)) {
              console.log('Report not found');
              return;
            }

            let report = fs.readFileSync(reportPath, 'utf8');

            // Truncate if too long for GitHub comment
            if (report.length > 30000) {
              report = report.substring(0, 30000) + '\n\n... (truncated - see artifacts for full report)';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“Š Audit Report\n\n${report}`
            });

      # ========================================================================
      # 13. SUMMARY
      # ========================================================================

      - name: ðŸ“‹ Summary
        if: always()
        run: |
          echo "=== AUDIT WORKFLOW COMPLETED ==="
          echo ""
          echo "Artifacts saved to: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "Check the following:"
          echo "  âœ… Audit logs in 'audit-logs' artifact"
          echo "  âœ… Full report in 'audit-report' artifact"
          echo "  âœ… PR comment with report summary (if on PR)"
        shell: bash
