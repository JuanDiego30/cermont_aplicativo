<!-- Botón flotante cuando está cerrado -->
@if (!isOpen()) {
  <button
    (click)="openChat()"
    class="fixed bottom-24 right-4 md:bottom-6 md:right-6 w-14 h-14 bg-linear-to-r from-blue-600 to-blue-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center z-40 group"
    aria-label="Abrir asistente IA">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
    </svg>
    <span class="absolute -top-2 -right-2 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
      <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
    </span>
    <span class="absolute right-full mr-3 px-3 py-1 bg-gray-900 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
      Asistente IA
    </span>
  </button>
}

<!-- Chat minimizado -->
@if (isOpen() && isMinimized()) {
  <div class="fixed bottom-24 right-4 md:bottom-6 md:right-6 z-40">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-72 border">
      <div class="flex items-center justify-between p-3 bg-linear-to-r from-blue-600 to-blue-700 rounded-t-xl">
        <div class="flex items-center gap-2 text-white">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
          </svg>
          <span class="font-medium text-sm">Asistente CERMONT</span>
        </div>
        <div class="flex items-center gap-1">
          <button (click)="maximizeChat()" class="p-1 hover:bg-white/20 rounded">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
          </button>
          <button (click)="closeChat()" class="p-1 hover:bg-white/20 rounded">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Chat completo -->
@if (isOpen() && !isMinimized()) {
  <div class="fixed bottom-24 right-4 md:bottom-6 md:right-6 z-40 max-md:left-4 max-md:right-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full md:w-96 max-h-[calc(100vh-120px)] md:max-h-[600px] flex flex-col border overflow-hidden">
      <!-- Header -->
      <div class="flex items-center justify-between p-4 bg-linear-to-r from-blue-600 to-blue-700">
        <div class="flex items-center gap-3 text-white">
          <div class="relative">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <span class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-400 rounded-full border-2 border-blue-600"></span>
          </div>
          <div>
            <h3 class="font-semibold">Asistente CERMONT</h3>
            <p class="text-xs text-blue-100">En línea • IA asistente</p>
          </div>
        </div>
        <div class="flex items-center gap-1">
          <button (click)="minimizeChat()" class="p-2 hover:bg-white/20 rounded-lg transition">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
            </svg>
          </button>
          <button (click)="closeChat()" class="p-2 hover:bg-white/20 rounded-lg transition">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Sugerencias rápidas -->
      <div class="p-3 border-b bg-gray-50 dark:bg-gray-900">
        <p class="text-xs text-gray-500 mb-2">Sugerencias rápidas:</p>
        <div class="flex flex-wrap gap-2">
          @for (sug of quickSuggestions; track sug.text) {
            <button
              (click)="handleSuggestion(sug.text)"
              class="flex items-center gap-1.5 px-2.5 py-1 bg-white dark:bg-gray-800 border rounded-full text-xs hover:bg-blue-50 hover:border-blue-300 transition">
              <span>{{ sug.icon }}</span>
              <span class="truncate max-w-[120px]">{{ sug.text }}</span>
            </button>
          }
        </div>
      </div>

      <!-- Mensajes -->
      <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 max-h-80">
        @for (message of messages(); track message.id) {
          <div class="flex gap-3" [class.flex-row-reverse]="message.role === 'user'">
            <!-- Avatar -->
            <div class="shrink-0 w-8 h-8 rounded-full flex items-center justify-center"
              [class.bg-blue-600]="message.role === 'user'"
              [class.bg-linear-to-br]="message.role === 'assistant'"
              [class.from-purple-500]="message.role === 'assistant'"
              [class.to-blue-500]="message.role === 'assistant'"
              [class.text-white]="true">
              @if (message.role === 'user') {
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              } @else {
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
              }
            </div>

            <!-- Mensaje -->
            <div class="max-w-[75%]" [class.text-right]="message.role === 'user'">
              <div class="rounded-2xl px-4 py-2.5"
                [class.bg-blue-600]="message.role === 'user'"
                [class.text-white]="message.role === 'user'"
                [class.rounded-br-md]="message.role === 'user'"
                [class.bg-gray-100]="message.role === 'assistant'"
                [class.dark:bg-gray-700]="message.role === 'assistant'"
                [class.text-gray-800]="message.role === 'assistant'"
                [class.dark:text-gray-200]="message.role === 'assistant'"
                [class.rounded-bl-md]="message.role === 'assistant'">
                <div class="text-sm whitespace-pre-wrap" [innerHTML]="formatMessage(message.content)"></div>
              </div>
              <p class="text-xs text-gray-400 mt-1 px-2">{{ formatTime(message.timestamp) }}</p>
            </div>
          </div>
        }

        <!-- Indicador de escritura -->
        @if (isTyping()) {
          <div class="flex gap-3">
            <div class="w-8 h-8 rounded-full bg-linear-to-br from-purple-500 to-blue-500 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
              </svg>
            </div>
            <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-bl-md px-4 py-3">
              <div class="flex gap-1">
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Input -->
      <div class="p-4 border-t bg-white dark:bg-gray-800">
        <div class="flex gap-2">
          <input
            type="text"
            [(ngModel)]="inputValue"
            (keydown)="handleKeyPress($event)"
            placeholder="Escribe tu mensaje..."
            class="flex-1 px-4 py-2.5 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600"
            [disabled]="isTyping()" />
          <button
            (click)="sendMessage()"
            [disabled]="!inputValue().trim() || isTyping()"
            class="px-4 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
            @if (isTyping()) {
              <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            } @else {
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
            }
          </button>
        </div>
        <p class="text-xs text-gray-400 text-center mt-2">
          Powered by CERMONT IA • Respuestas simuladas
        </p>
      </div>
    </div>
  </div>
}

