<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte de Costos - {{workPlan.id}}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      font-size: 11pt;
      line-height: 1.6;
      color: #333;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid #003d7a;
      padding-bottom: 15px;
      margin-bottom: 30px;
    }

    .logo {
      width: 150px;
      height: auto;
    }

    .company-info {
      text-align: right;
      font-size: 9pt;
      color: #666;
    }

    .company-info strong {
      color: #003d7a;
      font-size: 14pt;
    }

    h1 {
      text-align: center;
      color: #003d7a;
      font-size: 18pt;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: 10pt;
      margin-bottom: 30px;
    }

    .section {
      margin-bottom: 25px;
      page-break-inside: avoid;
    }

    .section-title {
      background-color: #003d7a;
      color: white;
      padding: 8px 12px;
      font-size: 12pt;
      font-weight: bold;
      margin-bottom: 15px;
      border-radius: 3px;
    }

    .cost-summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .cost-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .cost-card.budgeted {
      border-color: #2196f3;
      background-color: #e3f2fd;
    }

    .cost-card.actual {
      border-color: #4caf50;
      background-color: #e8f5e9;
    }

    .cost-card.variance {
      border-color: #ff9800;
      background-color: #fff3e0;
    }

    .cost-label {
      font-size: 12pt;
      font-weight: bold;
      color: #666;
      margin-bottom: 10px;
    }

    .cost-amount {
      font-size: 18pt;
      font-weight: bold;
      color: #003d7a;
    }

    .variance-positive {
      color: #4caf50;
    }

    .variance-negative {
      color: #f44336;
    }

    .variance-neutral {
      color: #ff9800;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 20px;
      margin-bottom: 15px;
    }

    .info-item {
      display: flex;
      padding: 8px;
      background-color: #f5f5f5;
      border-radius: 3px;
    }

    .info-label {
      font-weight: bold;
      color: #003d7a;
      min-width: 140px;
    }

    .info-value {
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      font-size: 10pt;
    }

    table th {
      background-color: #003d7a;
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: bold;
    }

    table td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }

    table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .analysis-section {
      background-color: #f8f9fa;
      border-left: 4px solid #003d7a;
      padding: 15px;
      margin: 20px 0;
      border-radius: 3px;
    }

    .analysis-title {
      font-weight: bold;
      color: #003d7a;
      margin-bottom: 10px;
    }

    .recommendations {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
      padding: 15px;
      margin: 20px 0;
    }

    .recommendations strong {
      color: #856404;
      display: block;
      margin-bottom: 8px;
    }

    .footer {
      margin-top: 50px;
      padding-top: 20px;
      border-top: 2px solid #ddd;
      text-align: center;
      font-size: 9pt;
      color: #666;
    }

    .signature-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 60px;
    }

    .signature-box {
      text-align: center;
    }

    .signature-line {
      border-top: 2px solid #333;
      margin-top: 80px;
      padding-top: 10px;
    }

    .signature-name {
      font-weight: bold;
      color: #003d7a;
    }

    .signature-role {
      font-size: 9pt;
      color: #666;
    }

    @media print {
      body {
        padding: 0;
      }

      .section {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div>
      <img src="data:image/png;base64,{{logoBase64}}" alt="CERMONT S.A.S." class="logo">
    </div>
    <div class="company-info">
      <strong>CERMONT S.A.S.</strong><br>
      NIT: 901.234.567-8<br>
      Arauca, Colombia<br>
      Tel: +57 300 123 4567
    </div>
  </div>

  <!-- Title -->
  <h1>Reporte de Costos</h1>
  <div class="subtitle">
    Plan de Trabajo: <strong>{{workPlan.id}}</strong> |
    Fecha: <strong>{{formatDate generatedAt}}</strong>
  </div>

  <!-- Resumen de Costos -->
  <div class="section">
    <div class="section-title">1. RESUMEN EJECUTIVO DE COSTOS</div>
    <div class="cost-summary">
      <div class="cost-card budgeted">
        <div class="cost-label">PRESUPUESTO INICIAL</div>
        <div class="cost-amount">{{formatCurrency workPlan.estimatedBudget}}</div>
      </div>
      <div class="cost-card actual">
        <div class="cost-label">COSTO REAL</div>
        <div class="cost-amount">{{formatCurrency realCost}}</div>
      </div>
      <div class="cost-card variance">
        <div class="cost-label">VARIACIÓN</div>
        <div class="cost-amount{{#if variance.isPositive}} variance-positive{{else if variance.isNegative}} variance-negative{{else}} variance-neutral{{/if}}">
          {{#if variance.isPositive}}+{{/if}}{{formatCurrency variance.amount}}
        </div>
        <div style="font-size: 10pt; margin-top: 5px; color: #666;">
          ({{variance.percentage}}%)
        </div>
      </div>
    </div>
  </div>

  <!-- Información del Proyecto -->
  <div class="section">
    <div class="section-title">2. INFORMACIÓN DEL PROYECTO</div>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">Orden de Trabajo:</span>
        <span class="info-value">{{workPlan.orderId}}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Cliente:</span>
        <span class="info-value">{{workPlan.clientName}}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Ubicación:</span>
        <span class="info-value">{{workPlan.location}}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Fecha Creación:</span>
        <span class="info-value">{{formatDate workPlan.createdAt}}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Técnico Responsable:</span>
        <span class="info-value">{{workPlan.technicianName}}</span>
      </div>
      <div class="info-item">
        <span class="info-label">Estado:</span>
        <span class="info-value">{{workPlan.status}}</span>
      </div>
    </div>
    <div class="info-item" style="grid-column: 1 / -1;">
      <span class="info-label">Descripción:</span>
      <span class="info-value">{{workPlan.description}}</span>
    </div>
  </div>

  <!-- Desglose de Materiales -->
  {{#if workPlan.materials}}
  <div class="section">
    <div class="section-title">3. DESGLOSE DE MATERIALES UTILIZADOS</div>
    <table>
      <thead>
        <tr>
          <th style="width: 40%;">Material</th>
          <th style="width: 15%; text-align: center;">Cantidad</th>
          <th style="width: 15%; text-align: center;">Unidad</th>
          <th style="width: 15%; text-align: right;">Costo Unit.</th>
          <th style="width: 15%; text-align: right;">Total</th>
        </tr>
      </thead>
      <tbody>
        {{#each workPlan.materials}}
        <tr>
          <td>{{this.name}}</td>
          <td style="text-align: center;">{{this.quantity}}</td>
          <td style="text-align: center;">{{this.unit}}</td>
          <td style="text-align: right;">{{formatCurrency this.unitCost}}</td>
          <td style="text-align: right;">{{formatCurrency (multiply this.quantity this.unitCost)}}</td>
        </tr>
        {{/each}}
      </tbody>
      <tfoot>
        <tr style="background-color: #e3f2fd;">
          <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL MATERIALES:</td>
          <td style="text-align: right; font-weight: bold; color: #003d7a;">{{formatCurrency materialsTotal}}</td>
        </tr>
      </tfoot>
    </table>
  </div>
  {{/if}}

  <!-- Mano de Obra -->
  {{#if workPlan.laborCost}}
  <div class="section">
    <div class="section-title">4. MANO DE OBRA</div>
    <table>
      <thead>
        <tr>
          <th style="width: 60%;">Concepto</th>
          <th style="width: 20%; text-align: center;">Horas</th>
          <th style="width: 20%; text-align: right;">Costo</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Mano de obra especializada</td>
          <td style="text-align: center;">{{workPlan.actualHours || workPlan.estimatedHours}}</td>
          <td style="text-align: right;">{{formatCurrency workPlan.laborCost}}</td>
        </tr>
      </tbody>
    </table>
  </div>
  {{/if}}

  <!-- Análisis de Variación -->
  <div class="section">
    <div class="section-title">5. ANÁLISIS DE VARIACIÓN</div>
    <div class="analysis-section">
      <div class="analysis-title">?? ANÁLISIS DE DESEMPEÑO ECONÓMICO</div>
      <p>
        El proyecto presenta una variación de <strong>{{variance.percentage}}%</strong>
        {{#if variance.isPositive}}
          <span style="color: #4caf50;">(FAVORABLE)</span> respecto al presupuesto inicial.
        {{else if variance.isNegative}}
          <span style="color: #f44336;">(DESFAVORABLE)</span> respecto al presupuesto inicial.
        {{else}}
          <span style="color: #ff9800;">(NEUTRO)</span> respecto al presupuesto inicial.
        {{/if}}
      </p>

      {{#if variance.isPositive}}
      <p><strong>Factores positivos identificados:</strong></p>
      <ul>
        <li>Optimización en el uso de materiales</li>
        <li>Eficiencia en la ejecución del trabajo</li>
        <li>Negociación favorable con proveedores</li>
      </ul>
      {{else if variance.isNegative}}
      <p><strong>Factores que contribuyeron a la variación:</strong></p>
      <ul>
        <li>Incremento en costos de materiales</li>
        <li>Tiempo adicional de ejecución</li>
        <li>Cambios en el alcance del proyecto</li>
      </ul>
      {{/if}}
    </div>
  </div>

  <!-- Recomendaciones -->
  <div class="recommendations">
    <strong>?? RECOMENDACIONES PARA FUTUROS PROYECTOS</strong>
    <ul>
      {{#if variance.isPositive}}
      <li>Continuar con las prácticas que generaron ahorro</li>
      <li>Documentar las estrategias exitosas para replicarlas</li>
      {{else if variance.isNegative}}
      <li>Revisar procesos de estimación de costos</li>
      <li>Implementar controles más estrictos durante la ejecución</li>
      <li>Negociar mejores condiciones con proveedores</li>
      {{/if}}
      <li>Realizar seguimiento continuo de costos vs presupuesto</li>
      <li>Mantener registro detallado de todas las variaciones</li>
    </ul>
  </div>

  <!-- Firmas -->
  <div class="signature-section">
    <div class="signature-box">
      <div class="signature-line">
        <div class="signature-name">{{workPlan.technicianName}}</div>
        <div class="signature-role">Técnico Responsable</div>
        <div class="signature-role">Fecha: {{formatDate generatedAt}}</div>
      </div>
    </div>
    <div class="signature-box">
      <div class="signature-line">
        <div class="signature-name">___________________________</div>
        <div class="signature-role">Gerente de Proyectos</div>
        <div class="signature-role">Fecha: _______________</div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>Este documento fue generado automáticamente por el Sistema de Gestión CERMONT</p>
    <p>Fecha de generación: {{formatDate generatedAt}} | Hora: {{formatTime generatedAt}}</p>
  </div>
</body>
</html>