generator client {
  provider = "prisma-client-js"
  // Generate the client in the root node_modules so the hoisted @prisma/client can find it
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  password           String
  name               String
  role               String
  avatar             String?
  active             Boolean   @default(true)
  mfaEnabled         Boolean   @default(false)
  mfaSecret          String?
  loginAttempts      Int       @default(0)
  passwordHistory    String    @default("[]")
  lastPasswordChange DateTime
  passwordExpiresAt  DateTime
  lastLogin          DateTime?
  lastFailedLogin    DateTime?
  lockedUntil        DateTime?
  createdBy          String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  orders            Order[]          @relation("OrderCreator")
  assignedOrders    Order[]          @relation("OrderResponsible")
  workPlans         WorkPlan[]       @relation("WorkPlanCreator")
  approvedWorkPlans WorkPlan[]       @relation("WorkPlanApprover")
  rejectedWorkPlans WorkPlan[]       @relation("WorkPlanRejecter")
  evidences         Evidence[]       @relation("EvidenceUploader")
  approvedEvidences Evidence[]       @relation("EvidenceApprover")
  rejectedEvidences Evidence[]       @relation("EvidenceRejecter")
  kits              Kit[]            @relation("KitCreator")
  auditLogs         AuditLog[]
  tokenBlacklist    TokenBlacklist[]
  refreshTokens     RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  notifications     Notification[]
  quoteRequests     QuoteRequest[]   @relation("ClientQuotes")
  createdTemplates  FormTemplate[]   @relation("TemplateCreator")
  formSubmissions   FormSubmission[] @relation("FormSubmitter")
  reviewedForms     FormSubmission[] @relation("FormReviewer")
  createdEquipment  CertifiedEquipment[] @relation("EquipmentCreator")
  assignedEquipment CertifiedEquipment[] @relation("AssignedEquipment")

  @@index([email])
  @@index([role])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String   @default("INFO") // INFO, SUCCESS, WARNING, ERROR
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model Order {
  id             String   @id @default(uuid())
  orderNumber    String   @unique
  clientName     String
  clientEmail    String?
  clientPhone    String?
  description    String
  state          String
  priority       String
  responsibleId  String
  createdBy      String
  archived       Boolean  @default(false)
  location       String?
  estimatedHours Int?
  billingState   String   @default("PENDING_ACTA") // PENDING_ACTA, ACTA_SIGNED, SES_SENT, INVOICED, PAID
  billingDetails Json? // { actaUrl, sesNumber, invoiceNumber, paymentDate, ... }
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  responsible User       @relation("OrderResponsible", fields: [responsibleId], references: [id])
  creator     User       @relation("OrderCreator", fields: [createdBy], references: [id])
  workPlans   WorkPlan[]
  evidences   Evidence[]
  costItems   CostItem[] @relation("OrderCosts")
  formSubmissions FormSubmission[] @relation("OrderFormSubmissions")

  @@index([state])
  @@index([billingState])
  @@index([responsibleId])
  @@index([createdBy])
}

model WorkPlan {
  id               String    @id @default(uuid())
  orderId          String
  title            String
  description      String
  status           String
  estimatedBudget  Float
  actualBudget     Float?
  materials        String?
  tools            String?
  equipment        String?
  ppe              String?
  asts             String?
  checklists       String?
  budgetBreakdown  String?
  tasks            String?
  attachments      String?
  safetyMeetings   String?
  assignedTeam     String?
  suggestedKitId   String?  // NEW: Link to suggested kit
  kitVerified      Boolean  @default(false) // NEW: Checkbox for kit verification
  plannedStart     DateTime?
  plannedEnd       DateTime?
  actualStart      DateTime?
  actualEnd        DateTime?
  notes            String?
  createdById      String
  approvedBy       String?
  approvedAt       DateTime?
  approvalComments String?
  rejectedBy       String?
  rejectedAt       DateTime?
  rejectionReason  String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  order         Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdBy     User                @relation("WorkPlanCreator", fields: [createdById], references: [id])
  approver      User?               @relation("WorkPlanApprover", fields: [approvedBy], references: [id])
  rejecter      User?               @relation("WorkPlanRejecter", fields: [rejectedBy], references: [id])
  costBreakdown CostBreakdownItem[]
  formSubmissions FormSubmission[] @relation("WorkplanFormSubmissions")

  @@index([orderId])
  @@index([status])
}

model CostBreakdownItem {
  id              String   @id @default(uuid())
  workPlanId      String
  category        String // LABOR, MATERIALS, EQUIPMENT, TRANSPORT, OTHER, TAX
  description     String
  estimatedAmount Float
  actualAmount    Float?
  quantity        Float    @default(1)
  unitPrice       Float?
  taxRate         Float    @default(0) // e.g., 0.19 for 19% IVA
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workPlan WorkPlan @relation(fields: [workPlanId], references: [id], onDelete: Cascade)

  @@index([workPlanId])
  @@index([category])
}

model Evidence {
  id               String    @id @default(uuid())
  orderId          String
  filename         String
  filepath         String
  mimetype         String
  size             Int
  stage            String
  type             String?
  status           String    @default("PENDING")
  checksum         String
  previousVersions String?
  metadata         String?
  approvalComments String?
  version          Int       @default(1)
  uploadedById     String
  approvedBy       String?
  approvedAt       DateTime?
  rejectedBy       String?
  rejectedAt       DateTime?
  rejectionReason  String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  order      Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  uploadedBy User  @relation("EvidenceUploader", fields: [uploadedById], references: [id])
  approver   User? @relation("EvidenceApprover", fields: [approvedBy], references: [id])
  rejecter   User? @relation("EvidenceRejecter", fields: [rejectedBy], references: [id])

  @@index([orderId])
  @@index([stage])
  @@index([status])
}

model AuditLog {
  id         String   @id @default(uuid())
  entityType String
  entityId   String
  action     String
  userId     String
  before     String?
  after      String?
  ip         String
  userAgent  String?
  reason     String?
  timestamp  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

model TokenBlacklist {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  type      String // Mantener como String en Prisma
  expiresAt DateTime
  revokedAt DateTime @default(now())
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model RefreshToken {
  id         String    @id @default(uuid())
  token      String    @unique
  userId     String
  family     String
  isRevoked  Boolean   @default(false)
  ipAddress  String?
  userAgent  String?
  expiresAt  DateTime
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([family])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@index([userId])
}

model Kit {
  id          String   @id @default(uuid())
  name        String
  description String
  category    String
  activityType String?  // NEW: For auto-suggestions based on order description
  active      Boolean  @default(true)
  tools       String   @default("[]")
  equipment   String   @default("[]")
  documents   String   @default("[]")
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  creator User @relation("KitCreator", fields: [createdBy], references: [id])

  @@index([category])
  @@index([active])
}

model OrderHistory {
  id          String   @id @default(uuid())
  originalId  String   @unique
  orderNumber String
  clientName  String
  description String
  finalState  String
  fullData    Json     // Snapshot completo de la orden
  archivedAt  DateTime @default(now())
  archivedBy  String?  // Sistema o usuario admin

  @@index([orderNumber])
  @@index([archivedAt])
  @@map("order_history")
}

model ArchiveLog {
  id          String   @id @default(uuid())
  orderId     String
  orderNumber String
  action      String   // ARCHIVED, RESTORED, DELETED
  performedBy String?  // "SYSTEM" or userId
  details     String?
  timestamp   DateTime @default(now())

  @@index([orderId])
  @@index([action])
  @@map("archive_logs")
}

// ========================================
// QUOTE REQUESTS (for CLIENT role)
// ========================================
model QuoteRequest {
  id          String   @id @default(uuid())
  clientId    String
  client      User     @relation("ClientQuotes", fields: [clientId], references: [id], onDelete: Cascade)
  title       String
  description String   @db.Text
  location    String?
  status      String   @default("PENDING") // PENDING, QUOTED, ACCEPTED, REJECTED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clientId])
  @@index([status])
  @@map("quote_requests")
}


// ========================================
// COST TRACKING (for cost comparison)
// ========================================
model CostItem {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation("OrderCosts", fields: [orderId], references: [id], onDelete: Cascade)
  category    String   // LABOR, MATERIALS, TRANSPORT, EQUIPMENT, OTHER
  description String
  estimated   Decimal  @db.Decimal(12, 2)
  actual      Decimal? @db.Decimal(12, 2)
  variance    Decimal? @db.Decimal(5, 2) // Percentage variance
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orderId])
  @@index([category])
  @@map("cost_items")
}

// ========================================
// DYNAMIC FORMS / PLANTILLAS DE FORMULARIO
// Sistema de formularios dinámicos (tipo Excel)
// ========================================
model FormTemplate {
  id            String   @id @default(uuid())
  name          String   // "Formato de Planeación de Obra", "Inspección Líneas de Vida"
  description   String?
  category      String?  // PLANEACION, INSPECCION, MANTENIMIENTO, ACTA, CHECKLIST
  activityType  String?  // Tipo de actividad asociada
  version       Int      @default(1)
  isActive      Boolean  @default(true)
  isDefault     Boolean  @default(false) // Template por defecto para categoría
  
  // Estructura del formulario como JSON
  // Incluye: secciones, campos, tipos, validaciones, orden
  schema        Json     // { sections: [{ title, fields: [{ id, label, type, required, options }] }] }
  
  // Configuración de PDF
  pdfConfig     Json?    // { header, footer, logo, orientation, margins }
  
  // Archivo PDF original de referencia (si lo suben)
  referencePdf  String?  // URL del PDF original
  
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  createdByUser User     @relation("TemplateCreator", fields: [createdBy], references: [id])
  submissions   FormSubmission[]

  @@index([category])
  @@index([activityType])
  @@index([isActive])
  @@map("form_templates")
}

// ========================================
// CERTIFIED EQUIPMENT (NUEVA FUNCIONALIDAD)
// Control de equipos y herramientas con certificaciones
// Resuelve: Falla #1 - Control de certificaciones
// ========================================
model CertifiedEquipment {
  id              String   @id @default(uuid())
  name            String
  description     String?  @db.Text
  category        String   // TOOL, EQUIPMENT, PPE, VEHICLE, INSTRUMENT
  manufacturer    String?
  model           String?
  serialNumber    String?  @unique
  
  // Certificación principal (JSON para flexibilidad)
  certification   Json     // { type, number, issueDate, expiryDate, issuedBy, documentUrl, verifiedBy, notes }
  
  // Certificaciones adicionales
  additionalCertifications Json?  // Array de certificaciones
  
  // Mantenimiento (JSON)
  maintenanceSchedule Json?  // { lastMaintenance, nextMaintenance, frequencyInDays, maintenanceType, lastMaintenanceBy }
  
  // Estado
  status          String   @default("AVAILABLE") // AVAILABLE, IN_USE, MAINTENANCE, EXPIRED, RETIRED
  location        String?  // Ubicación física
  assignedTo      String?  // Usuario asignado
  
  // Auditoría
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastUsedAt      DateTime?

  createdByUser   User?    @relation("EquipmentCreator", fields: [createdBy], references: [id])
  assignedUser    User?    @relation("AssignedEquipment", fields: [assignedTo], references: [id])

  @@index([category])
  @@index([status])
  @@index([serialNumber])
  @@index([assignedTo])
  @@map("certified_equipment")
}

// Envíos/respuestas de formularios
model FormSubmission {
  id            String   @id @default(uuid())
  templateId    String
  
  // Relación opcional con orden de trabajo y workplan
  orderId       String?
  workplanId    String?
  
  // Datos del formulario completado
  data          Json     // { fieldId: value, ... }
  
  // Firmas digitales
  signatures    Json?    // { [signatureFieldId]: base64String }
  
  // Evidencias/fotos adjuntas
  attachments   String[] // URLs de archivos adjuntos
  
  // Ubicación GPS al momento de envío
  location      Json?    // { lat, lng, accuracy, address }
  
  // Metadatos
  status        String   @default("draft") // draft, submitted, approved, rejected, pending_revision
  submittedBy   String
  submittedAt   DateTime @default(now())
  
  // Revisión
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNotes   String?
  
  // PDF generado
  pdfUrl        String?  // URL del PDF generado
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  template          FormTemplate @relation(fields: [templateId], references: [id])
  submittedByUser   User         @relation("FormSubmitter", fields: [submittedBy], references: [id])
  reviewedByUser    User?        @relation("FormReviewer", fields: [reviewedBy], references: [id])
  order             Order?       @relation("OrderFormSubmissions", fields: [orderId], references: [id])
  workplan          WorkPlan?    @relation("WorkplanFormSubmissions", fields: [workplanId], references: [id])

  @@index([templateId])
  @@index([orderId])
  @@index([workplanId])
  @@index([status])
  @@index([submittedBy])
  @@map("form_submissions")
}

// ========================================
// ACTAS DE CIERRE
// ========================================
model ClosingAct {
  id            String   @id @default(uuid())
  orderId       String   @unique
  
  // Información del acta
  title         String
  summary       String   @db.Text
  workDone      String   @db.Text // Descripción del trabajo realizado
  observations  String?  @db.Text
  recommendations String? @db.Text
  
  // Resultados de checklists asociados
  checklistResults Json? // [{ checklistId, name, items: [{ item, status }] }]
  
  // Evidencias incluidas
  evidenceIds   String[] // IDs de las evidencias a incluir
  
  // Firmas
  technicianSignature String? @db.Text
  technicianName      String?
  technicianSignedAt  DateTime?
  
  clientSignature     String? @db.Text
  clientName          String?
  clientSignedAt      DateTime?
  
  supervisorSignature String? @db.Text
  supervisorName      String?
  supervisorSignedAt  DateTime?
  
  // PDF generado
  pdfUrl        String?
  
  status        String   @default("DRAFT") // DRAFT, PENDING_SIGNATURE, SIGNED, FINALIZED
  
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  finalizedAt   DateTime?

  @@index([orderId])
  @@index([status])
  @@map("closing_acts")
}

// ========================================
// INSPECTION/MAINTENANCE RECORDS
// Registros de inspección y mantenimiento
// ========================================
model InspectionRecord {
  id            String   @id @default(uuid())
  orderId       String?
  
  type          String   // LINEA_VIDA, CCTV, ELECTRICO, etc.
  equipmentId   String?  // ID del equipo inspeccionado
  equipmentName String
  location      String?
  
  // Checklist de inspección
  checklistItems Json    // [{ item, status: 'CUMPLE'|'NO_CUMPLE'|'NA', notes }]
  
  // Resultado general
  result        String   // APROBADO, RECHAZADO, CONDICIONAL
  findings      String?  @db.Text // Hallazgos
  recommendations String? @db.Text
  
  // Evidencias
  photos        Json?    // [{ id, url, description, timestamp }]
  
  // Firma del inspector
  inspectorId   String
  inspectorSignature String? @db.Text
  
  // Próxima inspección
  nextInspectionDate DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orderId])
  @@index([type])
  @@index([result])
  @@index([inspectorId])
  @@map("inspection_records")
}

