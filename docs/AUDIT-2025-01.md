# üîç AUDITOR√çA INTEGRAL CERMONT ‚Äî 2025-01

**Fecha**: Enero 2025  
**Estado**: EN PROGRESO  
**Objetivo**: Dejar el repositorio en estado profesional con integraci√≥n FE‚ÜîBE completa

---

## üìã FASE 0: INVENTARIO T√âCNICO

### Stack Tecnol√≥gico

| Capa | Tecnolog√≠a | Versi√≥n |
|------|------------|---------|
| **Monorepo** | pnpm + Turborepo | 9.1.0 / 2.7.2 |
| **Backend** | NestJS | 11.x |
| **ORM** | Prisma | 5.22.0 |
| **Database** | PostgreSQL | - |
| **Frontend** | Angular Standalone | 21.x |
| **Styling** | Tailwind CSS | 4.x |
| **Node** | Node.js | >=20.0.0 |

---

### Frontend API Files (10 dominios)

| Archivo | Ruta | Endpoints |
|---------|------|-----------|
| `admin.api.ts` | `/admin/*` | listUsers, updateUserRole, updateUserStatus, deleteUser, getStats |
| `auth.api.ts` | `/auth/*` | login, register, logout (client-side) |
| `dashboard.api.ts` | `/dashboard/*` | getStats, getMetricas, getOrdenesRecientes, getKPIs, getCostosBreakdown, getPerformanceTrends, refreshKPIs |
| `evidencias.api.ts` | `/evidencias/*` | uploadEvidence, getById, getByOrdenId, delete, downloadFile |
| `kits.api.ts` | `/kits/*` | list, getById, create, update, delete, addItem, removeItem, activate, deactivate |
| `mantenimientos.api.ts` | `/mantenimientos/*` | list, getById, getProximos, getVencidos, create, update, ejecutar, programar, delete |
| `ordenes.api.ts` | `/ordenes/*` | list, getById, create, update, delete, changeEstado, asignarTecnico, getHistorial, getStats |
| `planeacion.api.ts` | `/planeacion/*` | getByOrden, createOrUpdate, aprobar, rechazar |
| `reportes.api.ts` | `/reportes/*` | reporteOrdenes, reporteOrden, downloadReportePDF |
| `tecnicos.api.ts` | `/tecnicos/*` | list, getById, getDisponibles, changeDisponibilidad |

---

### Backend Modules (25 m√≥dulos)

| M√≥dulo | Controlador | Rutas |
|--------|-------------|-------|
| admin | ‚úÖ AdminController | `/admin/*` |
| alertas | ‚ùå Sin controller | - |
| archivado-historico | ‚úÖ Controller | `/archivado-historico/*` |
| auth | ‚úÖ AuthController | `/auth/*` |
| certificaciones | ‚úÖ Controller | `/certificaciones/*` |
| checklists | ‚úÖ Controller | `/checklists/*` |
| cierre-administrativo | ‚úÖ Controller | `/cierre-administrativo/*` |
| clientes | ‚úÖ Controller | `/clientes/*` |
| costos | ‚úÖ CostosController | `/costos/*` |
| dashboard | ‚úÖ DashboardController | `/dashboard/*` |
| ejecucion | ‚úÖ Controller | `/ejecucion/*` |
| evidencias | ‚úÖ EvidenciasController | `/evidencias/*` |
| facturacion | ‚úÖ Controller | `/facturacion/*` |
| formularios | ‚ùå Sin controller REST | - |
| hes | ‚ùì Por verificar | - |
| kits | ‚úÖ KitsController | `/kits/*` |
| kpis | ‚úÖ KpisController | `/kpis/*` |
| notifications | ‚ùå Sin controller REST | - |
| ordenes | ‚úÖ OrdenesController | `/ordenes/*` |
| pdf-generation | ‚úÖ PdfController | `/pdf/*` |
| planeacion | ‚úÖ PlaneacionController | `/planeacion/*` |
| reportes | ‚úÖ ReportesController | `/reportes/*` |
| sync | ‚úÖ SyncController | `/sync/*` |
| tecnicos | ‚úÖ TecnicosController | `/tecnicos/*` |
| weather | ‚úÖ WeatherController | `/weather/*` |

---

## üìä FASE 1: TABLA DE INTEGRACI√ìN FE ‚Üî BE

### Mapeo de Endpoints

| FE API | Endpoint FE | Controller BE | Endpoint BE | Status | Problema |
|--------|-------------|---------------|-------------|--------|----------|
| **auth.api** | POST `/auth/login` | AuthController | POST `/auth/login` | ‚úÖ OK | - |
| **auth.api** | POST `/auth/register` | AuthController | POST `/auth/register` | ‚úÖ OK | - |
| **auth.api** | `logout()` (client) | - | - | ‚ö†Ô∏è | Solo limpia localStorage, no revoca refresh token |
| **admin.api** | GET `/admin/users` | AdminController | GET `/admin/users` | ‚úÖ OK | - |
| **admin.api** | PATCH `/admin/users/:id/role` | AdminController | PATCH `/admin/users/:id/role` | ‚úÖ OK | - |
| **admin.api** | PATCH `/admin/users/:id/status` | AdminController | ‚ùì | ‚ö†Ô∏è | FE usa `/status`, BE usa `/active` (toggle) |
| **admin.api** | DELETE `/admin/users/:id` | AdminController | ‚ùå | üî¥ NO | No hay endpoint DELETE user en BE |
| **admin.api** | GET `/admin/stats` | AdminController | GET `/admin/stats` | ‚úÖ OK | - |
| **ordenes.api** | GET `/ordenes` | OrdenesController | GET `/ordenes` | ‚úÖ OK | - |
| **ordenes.api** | GET `/ordenes/:id` | OrdenesController | GET `/ordenes/:id` | ‚úÖ OK | - |
| **ordenes.api** | POST `/ordenes` | OrdenesController | POST `/ordenes` | ‚úÖ OK | - |
| **ordenes.api** | PATCH `/ordenes/:id` | OrdenesController | PATCH `/ordenes/:id` | ‚úÖ OK | - |
| **ordenes.api** | DELETE `/ordenes/:id` | OrdenesController | DELETE `/ordenes/:id` | ‚úÖ OK | - |
| **ordenes.api** | POST `/ordenes/:id/cambiar-estado` | OrdenesController | POST `/ordenes/:id/cambiar-estado` | ‚úÖ OK | - |
| **ordenes.api** | POST `/ordenes/:id/asignar-tecnico` | OrdenesController | POST `/ordenes/:id/asignar-tecnico` | ‚úÖ OK | - |
| **ordenes.api** | GET `/ordenes/:id/historial` | OrdenesController | GET `/ordenes/:id/historial` | ‚úÖ OK | - |
| **ordenes.api** | GET `/ordenes/stats` | OrdenesController | ‚ùå | üî¥ NO | No existe endpoint /stats en OrdenesController |
| **dashboard.api** | GET `/dashboard/stats` | DashboardController | GET `/dashboard/stats` | ‚úÖ OK | - |
| **dashboard.api** | GET `/dashboard/metricas` | DashboardController | GET `/dashboard/metricas` | ‚úÖ OK | - |
| **dashboard.api** | GET `/dashboard/ordenes-recientes` | DashboardController | GET `/dashboard/ordenes-recientes` | ‚úÖ OK | - |
| **dashboard.api** | GET `/dashboard/kpis` | DashboardController | GET `/dashboard/overview` | ‚ö†Ô∏è | Path difiere: FE usa `/kpis`, BE usa `/overview` |
| **dashboard.api** | POST `/dashboard/kpis/refresh` | DashboardController | GET `/dashboard/kpis/refresh` | ‚ö†Ô∏è | FE usa POST, BE usa GET |
| **evidencias.api** | POST `/evidencias/upload` | EvidenciasController | POST `/evidencias` (upload) | ‚ö†Ô∏è | Path difiere |
| **evidencias.api** | GET `/evidencias/:id` | EvidenciasController | GET `/evidencias/:id` | ‚úÖ OK | - |
| **evidencias.api** | GET `/evidencias/orden/:ordenId` | EvidenciasController | GET `/evidencias/orden/:ordenId` | ‚úÖ OK | - |
| **evidencias.api** | DELETE `/evidencias/:id` | EvidenciasController | DELETE `/evidencias/:id` | ‚úÖ OK | - |
| **evidencias.api** | GET `/evidencias/:id/download` | EvidenciasController | GET `/evidencias/:id/download` | ‚úÖ OK | - |
| **kits.api** | GET `/kits` | KitsController | GET `/kits` | ‚úÖ OK | - |
| **kits.api** | GET `/kits/:id` | KitsController | GET `/kits/:id` | ‚úÖ OK | - |
| **kits.api** | POST `/kits` | KitsController | POST `/kits` | ‚úÖ OK | - |
| **kits.api** | PUT `/kits/:id` | KitsController | PUT `/kits/:id` | ‚úÖ OK | - |
| **kits.api** | DELETE `/kits/:id` | KitsController | DELETE `/kits/:id` | ‚úÖ OK | - |
| **kits.api** | POST `/kits/:id/items` | KitsController | POST `/kits/:id/items` | ‚úÖ OK | - |
| **kits.api** | DELETE `/kits/:id/items/:itemId` | KitsController | DELETE `/kits/:id/items/:itemId` | ‚úÖ OK | - |
| **kits.api** | PATCH `/kits/:id/activate` | KitsController | PATCH `/kits/:id/activate` | ‚úÖ OK | - |
| **kits.api** | PATCH `/kits/:id/deactivate` | KitsController | PATCH `/kits/:id/deactivate` | ‚úÖ OK | - |
| **mantenimientos.api** | GET `/mantenimientos` | ‚ùå | ‚ùå | üî¥ NO | **M√ìDULO NO EXISTE EN BACKEND** |
| **mantenimientos.api** | GET `/mantenimientos/:id` | ‚ùå | ‚ùå | üî¥ NO | **M√ìDULO NO EXISTE EN BACKEND** |
| **mantenimientos.api** | GET `/mantenimientos/proximos` | ‚ùå | ‚ùå | üî¥ NO | **M√ìDULO NO EXISTE EN BACKEND** |
| **mantenimientos.api** | GET `/mantenimientos/vencidos` | ‚ùå | ‚ùå | üî¥ NO | **M√ìDULO NO EXISTE EN BACKEND** |
| **mantenimientos.api** | POST `/mantenimientos` | ‚ùå | ‚ùå | üî¥ NO | **M√ìDULO NO EXISTE EN BACKEND** |
| **mantenimientos.api** | PATCH `/mantenimientos/:id` | ‚ùå | ‚ùå | üî¥ NO | **M√ìDULO NO EXISTE EN BACKEND** |
| **mantenimientos.api** | POST `/mantenimientos/:id/ejecutar` | ‚ùå | ‚ùå | üî¥ NO | **M√ìDULO NO EXISTE EN BACKEND** |
| **mantenimientos.api** | POST `/mantenimientos/:id/programar` | ‚ùå | ‚ùå | üî¥ NO | **M√ìDULO NO EXISTE EN BACKEND** |
| **mantenimientos.api** | DELETE `/mantenimientos/:id` | ‚ùå | ‚ùå | üî¥ NO | **M√ìDULO NO EXISTE EN BACKEND** |
| **planeacion.api** | GET `/planeacion/:ordenId` | PlaneacionController | GET `/planeacion/:ordenId` | ‚úÖ OK | - |
| **planeacion.api** | POST `/planeacion/:ordenId` | PlaneacionController | POST `/planeacion/:ordenId` | ‚úÖ OK | - |
| **planeacion.api** | PUT `/planeacion/:id/aprobar` | PlaneacionController | PUT `/planeacion/:id/aprobar` | ‚úÖ OK | - |
| **planeacion.api** | PUT `/planeacion/:id/rechazar` | PlaneacionController | PUT `/planeacion/:id/rechazar` | ‚úÖ OK | - |
| **reportes.api** | GET `/reportes/ordenes` | ReportesController | GET `/reportes/ordenes` | ‚úÖ OK | - |
| **reportes.api** | GET `/reportes/orden/:id` | ReportesController | GET `/reportes/orden/:id` | ‚úÖ OK | - |
| **reportes.api** | GET `/reportes/orden/:id/pdf` | ReportesController | ‚ùì | ‚ö†Ô∏è | Verificar si existe o usa PdfController |
| **tecnicos.api** | GET `/tecnicos` | TecnicosController | GET `/tecnicos` | ‚úÖ OK | - |
| **tecnicos.api** | GET `/tecnicos/:id` | TecnicosController | GET `/tecnicos/:id` | ‚úÖ OK | - |
| **tecnicos.api** | GET `/tecnicos/disponibles` | TecnicosController | GET `/tecnicos/disponibles` | ‚úÖ OK | - |
| **tecnicos.api** | PATCH `/tecnicos/:id/disponibilidad` | TecnicosController | PATCH `/tecnicos/:id/disponibilidad` | ‚úÖ OK | - |

---

## üìä FASE 2: AUDIT ENUMS / TYPES / DTOs

### Enums de Estado de Orden

| Ubicaci√≥n | Enum | Valores |
|-----------|------|---------|
| **FE** `orden.model.ts` | `OrdenEstado` | PENDIENTE, PLANEACION, EN_PROGRESO, EJECUCION, COMPLETADA, CANCELADA, ARCHIVADA |
| **BE** `orden-estado.enum.ts` | `OrdenEstado` | pendiente, planeacion, ejecucion, completada, cancelada, pausada |
| **BE** `order-state.enum.ts` | `OrderState` | pendiente, planeacion, ejecucion, pausada, completada, cancelada |

#### ÔøΩ DISCREPANCIAS CORREGIDAS (Sprint 1.2):

1. ~~**EN_PROGRESO**: FE ten√≠a `EN_PROGRESO`, BE NO lo ten√≠a~~ ‚Üí **ELIMINADO** (mapea a EJECUCION)
2. ~~**ARCHIVADA**: FE ten√≠a `ARCHIVADA`, BE NO lo ten√≠a~~ ‚Üí **ELIMINADO**
3. ‚úÖ **PAUSADA**: Agregado al flujo de transiciones FE

**Status actual: FE y BE alineados con 6 estados: PENDIENTE, PLANEACION, EJECUCION, PAUSADA, COMPLETADA, CANCELADA**

---

### Enums de UserRole

| Ubicaci√≥n | Enum | Valores |
|-----------|------|---------|
| **FE** `user.model.ts` | `UserRole` | ADMIN, SUPERVISOR, TECNICO, ADMINISTRATIVO, GERENTE |
| **BE** `user-role.enum.ts` | `UserRole` | admin, supervisor, tecnico, administrativo, gerente |

‚úÖ **ALINEADOS** tras PR 1.1 (mismos valores, diferente case)

---

### Uso de `any` detectado

| Archivo | L√≠nea | Problema |
|---------|-------|----------|
| `admin.api.ts` | L33 | `filters?: any` ‚Äî Falta tipado de filtros |

---

### Enums Duplicados

| Enum | Ubicaciones | Acci√≥n |
|------|-------------|--------|
| `OrdenEstado` / `OrderState` | `common/enums/`, `ordenes/domain/enums/` | Consolidar en uno solo |

---

## üìä FASE 3: DEPENDENCIAS

### Dependencias Compartidas (posible duplicaci√≥n)

| Paquete | API | Web | Acci√≥n |
|---------|-----|-----|--------|
| `zod` | ‚úÖ 3.24.4 | ‚ùå No | OK (solo BE valida) |
| `class-validator` | ‚úÖ | ‚ùå | OK |
| `rxjs` | ‚úÖ 7.8.2 | ‚úÖ 7.8.2 | ‚ö†Ô∏è Mismo version, considerar hoist |

### Dependencias Cr√≠ticas

- **Puppeteer** (BE): Para PDF generation
- **Sharp** (BE): Para procesamiento de im√°genes
- **ApexCharts** (FE): Para gr√°ficos dashboard
- **FullCalendar** (FE): Para calendarios

---

## üö® HALLAZGOS CR√çTICOS

### ‚úÖ CORREGIDOS en esta sesi√≥n

1. ~~**Enums de Estado DESALINEADOS**~~ ‚Üí **SOLUCIONADO**
   - Alineado FE con BE: 6 estados (PENDIENTE, PLANEACION, EJECUCION, PAUSADA, COMPLETADA, CANCELADA)
   - Eliminados EN_PROGRESO y ARCHIVADA del FE
   - Archivos corregidos: `orden-detail.component.ts`, `ordenes-list.component.ts`, `dashboard.component.ts`, `ordenes.service.ts`

2. ~~**Error sintaxis admin.controller.ts**~~ ‚Üí **SOLUCIONADO**
   - Agregado import `Delete` faltante
   - Eliminado c√≥digo residual corrupto

3. ~~**Error tipo EstadoPlaneacion**~~ ‚Üí **SOLUCIONADO**
   - Agregado cast `as EstadoPlaneacion` en use cases

### Prioridad ALTA (üî¥) - Pendientes

1. **M√≥dulo Mantenimientos NO EXISTE en Backend**
   - FE: `mantenimientos.api.ts` con 9 endpoints
   - BE: Sin m√≥dulo ni controller
   - **Impacto**: Feature completo sin backend

### Prioridad MEDIA (‚ö†Ô∏è)

4. **Dashboard endpoints path mismatch**
   - `/dashboard/kpis` vs `/dashboard/overview`
   - `/dashboard/kpis/refresh`: POST vs GET

5. **Admin user status endpoint mismatch**
   - FE: `/admin/users/:id/status`
   - BE: `/admin/users/:id/active` (toggle)

6. **Auth logout incompleto**
   - Solo limpia localStorage
   - No llama a `/auth/logout` del BE para revocar refresh token

### Prioridad BAJA (‚ö°)

7. **Uso de `any`** en admin.api.ts
8. **Enums duplicados** OrdenEstado vs OrderState en BE

---

## üìã FASE 4: PLAN DE SPRINTS

### Sprint 1: Fundamentos (3-5 d√≠as)

| ID | Tarea | Prioridad | Archivos | Status |
|----|-------|-----------|----------|--------|
| 1.1 | ‚úÖ Alinear UserRole FE‚ÜîBE | ALTA | PR anterior | **DONE** |
| 1.2 | ‚úÖ Alinear OrdenEstado FE‚ÜîBE | ALTA | `orden-detail.component.ts`, `ordenes-list.component.ts`, `dashboard.component.ts`, `ordenes.service.ts` | **DONE** |
| 1.3 | ‚úÖ Fix errores sintaxis admin.controller.ts | ALTA | `admin.controller.ts` | **DONE** |
| 1.4 | ‚úÖ Fix errores tipo EstadoPlaneacion | MEDIA | `*-planeacion.use-case.ts` | **DONE** |
| 1.5 | Fix auth logout para llamar BE | MEDIA | `auth.api.ts`, `auth.service.ts` | PENDING |

### Sprint 2: Endpoints Faltantes (5-7 d√≠as)

| ID | Tarea | Prioridad | Archivos |
|----|-------|-----------|----------|
| 2.1 | Crear endpoint `/ordenes/stats` | ALTA | `ordenes.controller.ts` |
| 2.2 | Alinear Dashboard KPIs path | ALTA | `dashboard.api.ts` o controller |
| 2.3 | Alinear admin user status endpoint | MEDIA | `admin.api.ts` o controller |
| 2.4 | Implementar DELETE user en admin | BAJA | `admin.controller.ts` |

### Sprint 3: M√≥dulo Mantenimientos (7-10 d√≠as)

| ID | Tarea | Prioridad | Archivos |
|----|-------|-----------|----------|
| 3.1 | Crear m√≥dulo mantenimientos en BE | ALTA | Nuevo m√≥dulo completo |
| 3.2 | Crear entity/domain Mantenimiento | ALTA | Schema Prisma + domain |
| 3.3 | Implementar CRUD b√°sico | ALTA | Controller + service |
| 3.4 | Implementar endpoints especiales | MEDIA | pr√≥ximos, vencidos, ejecutar, programar |

### Sprint 4: Limpieza y Calidad (3-5 d√≠as)

| ID | Tarea | Prioridad | Archivos |
|----|-------|-----------|----------|
| 4.1 | Eliminar `any` y tipar filtros | BAJA | `admin.api.ts` |
| 4.2 | Verificar cobertura tests | MEDIA | Tests existentes |
| 4.3 | Documentar API con Swagger | BAJA | Controllers |

---

## ‚úÖ SIGUIENTE PASO

**Acci√≥n inmediata recomendada**: Empezar con Sprint 1.2 ‚Äî Alinear OrdenEstado

¬øDesea proceder con la implementaci√≥n del Sprint 1.2?

---

*Documento generado autom√°ticamente ‚Äî Auditor√≠a CERMONT 2025*
